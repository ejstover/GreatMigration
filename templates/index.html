<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{DOC_TITLE}}</title>
  <link rel="icon" type="image/png" href="/static/logo.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'media' };</script>

  <style>
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color: #60a5fa; background: #f8fafc; }
    pre { white-space: pre-wrap; word-wrap: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .status-info { border-color: #bae6fd; background: #ecfeff; }
    .status-success { border-color: #86efac; background: #f0fdf4; }
    .status-error { border-color: #fecaca; background: #fef2f2; }
    .tooltip { position: relative; display: inline-flex; align-items: center; gap: .35rem; }
    .tooltip .tip {
      visibility: hidden; opacity: 0; transition: opacity .15s ease;
      position: absolute; left: 50%; transform: translateX(-50%);
      bottom: 130%; min-width: 18rem; max-width: 28rem;
      background: #0f172a; color: #f8fafc; padding: .5rem .75rem; border-radius: .5rem; font-size: .75rem;
      box-shadow: 0 10px 25px rgba(2,6,23,0.25); z-index: 50; text-align: left;
    }
    .tooltip:hover .tip { visibility: visible; opacity: 1; }
  </style>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 overflow-x-hidden">
    <nav id="menu" class="fixed inset-y-0 left-0 w-64 bg-white text-slate-900 dark:bg-slate-800 dark:text-slate-100 transform -translate-x-full transition-transform duration-300 z-50 shadow-lg p-4 space-y-2">
      <p id="user_greeting" class="hidden px-4 py-2 font-semibold"></p>
      <a href="/hardware" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_HARDWARE}}</a>
      <a href="/replacements" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_REPLACEMENTS}}</a>
      <a href="/" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_CONFIG}}</a>
      <a href="/rules" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_RULES}}</a>
      <a href="/audit" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_AUDIT}}</a>
      <a href="{{HELP_URL}}" target="_blank" rel="noopener" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Help</a>
      <button id="logout_btn" class="hidden w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Log out</button>
    </nav>
    <div id="main" class="transition-all duration-300">
    <header class="mb-6 bg-gradient-to-r from-emerald-500 to-sky-500 text-white shadow-lg">
      <div class="max-w-7xl mx-auto flex items-center gap-4 p-6">
        <button id="menu_btn" class="p-2 rounded hover:bg-white/30" aria-label="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex items-center gap-4">
          <img src="/static/logo.png" alt="Logo" class="h-16 w-16" />
          <div>
            <h1 class="text-3xl font-bold">{{BANNER_TITLE}}</h1>
            <p class="text-slate-100 text-sm md:text-base">{{BANNER_TAGLINE}}</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto p-6">
      <!-- SSH Retrieval -->
      <section class="mb-6">
        <div class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-2">Fetch running configs via SSH</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Enter the Cisco switches to collect <code>show running-config</code>. The configs are converted automatically once collection completes.</p>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="cfg_ssh_devices" class="block text-sm font-medium mb-1">Devices (one per line)</label>
              <textarea id="cfg_ssh_devices" class="w-full border rounded-lg p-3 min-h-[8rem] dark:bg-slate-900 dark:border-slate-700" placeholder="switch1.example.com&#10;10.0.0.5"></textarea>
            </div>
            <div class="space-y-4">
              <div>
                <label for="cfg_ssh_username" class="block text-sm font-medium mb-1">SSH username</label>
                <input id="cfg_ssh_username" type="text" class="w-full border rounded-lg p-3 dark:bg-slate-900 dark:border-slate-700" autocomplete="username" />
              </div>
              <div>
                <label for="cfg_ssh_password" class="block text-sm font-medium mb-1">SSH password</label>
                <div class="relative">
                  <input id="cfg_ssh_password" type="password" class="w-full border rounded-lg p-3 pr-16 dark:bg-slate-900 dark:border-slate-700" autocomplete="current-password" />
                  <button type="button" id="cfg_ssh_toggle_password" class="absolute inset-y-0 right-0 px-3 text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-200">Show</button>
                </div>
              </div>
              <p class="text-xs text-slate-500 dark:text-slate-400">Usernames persist locally for convenience. Passwords clear immediately after the job starts.</p>
            </div>
          </div>
          <div class="flex items-center gap-3 mt-4">
            <button id="cfg_ssh_collect" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Fetch configs</button>
            <span id="cfg_ssh_progress" class="text-sm text-slate-600 dark:text-slate-300"></span>
          </div>
          <div id="cfg_ssh_failure_panel" class="hidden mt-4 rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700 dark:border-rose-900 dark:bg-rose-950/70 dark:text-rose-100">
            <div id="cfg_ssh_failure_summary" class="font-semibold"></div>
            <ul id="cfg_ssh_failure_list" class="mt-3 space-y-3"></ul>
          </div>
        </div>
      </section>

      <!-- Drag & Drop -->
      <section class="mb-6">
      <div id="dz" class="dropzone rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 p-8 text-center text-slate-500 dark:text-slate-300">
        <p class="mb-2">Drag & drop Cisco config files here (or click to select)</p>
        <input id="file_input" type="file" multiple class="hidden" accept=".txt,.cfg,.conf,.json" />
        <button id="choose_files" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Choose files</button>
      </div>
      <div class="flex items-center justify-between mt-2">
        <div id="convert_status" class="text-sm text-slate-600 dark:text-slate-300"></div>
        <button id="clear_all" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Clear</button>
      </div>
    </section>

    <!-- Converted JSON -->
    <section id="results" class="hidden mb-8">
      <h2 class="text-lg font-medium mb-2">Converted JSON Preview</h2>
      <div id="results_list" class="space-y-4"></div>
    </section>

    <!-- Batch Push -->
    <section id="batch_section" class="hidden">
      <h2 class="text-lg font-medium mb-2">Batch: Map files to switches</h2>

      <!-- Global options -->
      <div class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-4 mb-4">
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Time zone</label>
            <input id="tz" type="text" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" value="America/New_York" readonly />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Model override (optional, applies to rows without their own override)</label>
            <input id="model_override" type="text" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" placeholder="EX4100-48MP" />
          </div>
          <div class="flex items-center gap-6 mt-6 md:mt-0">
            <label class="tooltip">
              <span class="inline-flex items-center gap-2">
                <input id="strict_overflow" type="checkbox" class="w-4 h-4" />
                <span class="text-sm">Strict overflow (convert)</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
              <span class="tip">If checked during conversion, any interface that canâ€™t be mapped cleanly (e.g., out-of-range module/port) is dropped instead of guessed.</span>
            </label>
          </div>
        </div>

        <div class="mt-6 border-t border-slate-200 dark:border-slate-700 pt-4 space-y-6">
          <div>
            <div class="flex items-start gap-3 mb-4">
              <span class="mt-1 inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-emerald-100 text-xs font-bold tracking-wide text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">SDA</span>
              <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Site Deployment Automation</p>
                <h3 class="text-base font-semibold text-slate-800 dark:text-slate-100">Convert Cisco configs into Juniper API payloads</h3>
                <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Choose whether to simulate or push the converted payloads so the output always matches the Site Deployment steps you plan to run.</p>
              </div>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
              <label class="tooltip relative flex flex-col gap-2 rounded-xl border border-slate-200 bg-slate-50/60 p-3 shadow-sm transition hover:border-emerald-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900/40">
                <span class="flex items-start gap-3">
                  <input id="site_stage" type="checkbox" class="mt-1 h-4 w-4" />
                  <span>
                    <span class="block text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">Site stage Â· Test</span>
                    <span class="block text-sm font-medium text-slate-800 dark:text-slate-100">Stage/Test converted config</span>
                    <span class="mt-1 block text-xs text-slate-600 dark:text-slate-300">Build the Juniper-ready payloads without pushing them so you can review exactly what will be sent to Mist.</span>
                  </span>
                </span>
                <span class="absolute right-3 top-3 inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-200 text-xs font-bold text-emerald-700 dark:bg-emerald-900 dark:text-emerald-200">?</span>
                <span class="tip">Runs the Cisco â†’ Juniper conversion and shows the Mist request bodies without applying any live changes.</span>
              </label>

              <label class="tooltip relative flex flex-col gap-2 rounded-xl border border-slate-200 bg-slate-50/60 p-3 shadow-sm transition hover:border-emerald-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900/40">
                <span class="flex items-start gap-3">
                  <input id="site_push" type="checkbox" class="mt-1 h-4 w-4" />
                  <span>
                    <span class="block text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">Site stage Â· Push</span>
                    <span class="block text-sm font-medium text-slate-800 dark:text-slate-100">Push converted config</span>
                    <span class="mt-1 block text-xs text-slate-600 dark:text-slate-300">Apply the converted payloads to Mist-managed switches when you are ready to deploy the new Juniper configuration.</span>
                  </span>
                </span>
                <span class="absolute right-3 top-3 inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-200 text-xs font-bold text-emerald-700 dark:bg-emerald-900 dark:text-emerald-200">?</span>
                <span class="tip">Sends the converted port configuration to Mist. Select only this push option when you are ready for a live update.</span>
              </label>
            </div>
          </div>

          <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
            <div class="flex items-start gap-3 mb-4">
              <span class="mt-1 inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-sky-100 text-xs font-bold tracking-wide text-sky-700 dark:bg-sky-900/40 dark:text-sky-200">LCM</span>
              <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Lifecycle automation</p>
                <h3 class="text-base font-semibold text-slate-800 dark:text-slate-100">Mist LCM actions for Cisco â†’ Juniper swaps</h3>
                <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Pick the automation phases that stage, cut over, and clean up the migration so operators know exactly which Life Cycle Management (LCM) tasks will run.</p>
              </div>
            </div>
            <div class="grid gap-4 md:grid-cols-3">
              <label class="tooltip relative flex flex-col gap-2 rounded-xl border border-slate-200 bg-slate-50/60 p-3 shadow-sm transition hover:border-sky-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900/40">
                <span class="flex items-start gap-3">
                  <input id="apply_temp_config" type="checkbox" class="mt-1 h-4 w-4" />
                  <span>
                  <span class="block text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">LCM Step 1 Â· Stage</span>
                  <span class="block text-sm font-medium text-slate-800 dark:text-slate-100">Stage the temporary Cisco layout</span>
                  <span class="mt-1 block text-xs text-slate-600 dark:text-slate-300">Create VLANs, port profiles, and switchport assignments that mirror the legacy Cisco network on the Juniper hardware.</span>
                </span>
              </span>
              <span class="absolute right-3 top-3 inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-200 text-xs font-bold text-sky-700 dark:bg-sky-900 dark:text-sky-200">?</span>
              <span class="tip">Stages the generated payload as a temporary config on each switch after a successful push. This is the LCM staging step for the Cisco â†’ Juniper migration.</span>
            </label>

            <label class="tooltip relative flex flex-col gap-2 rounded-xl border border-slate-200 bg-slate-50/60 p-3 shadow-sm transition hover:border-sky-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900/40">
              <span class="flex items-start gap-3">
                <input id="finalize_assignments" type="checkbox" class="mt-1 h-4 w-4" />
                <span>
                  <span class="block text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">LCM Step 2 Â· Finalize</span>
                  <span class="block text-sm font-medium text-slate-800 dark:text-slate-100">Commit LCM assignments</span>
                  <span class="mt-1 block text-xs text-slate-600 dark:text-slate-300">Move the staged temporary assignments into production once you are ready to complete the cutover.</span>
                </span>
              </span>
              <span class="absolute right-3 top-3 inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-200 text-xs font-bold text-sky-700 dark:bg-sky-900 dark:text-sky-200">?</span>
              <span class="tip">Moves the temporary port assignments into production after staging completes. Use this when the LCM workflow is ready to finalize.</span>
            </label>

            <label class="tooltip relative flex flex-col gap-2 rounded-xl border border-slate-200 bg-slate-50/60 p-3 shadow-sm transition hover:border-sky-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900/40">
              <span class="flex items-start gap-3">
                <input id="remove_temp_config" type="checkbox" class="mt-1 h-4 w-4" />
                <span>
                  <span class="block text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">LCM Step 3 Â· Clean up</span>
                  <span class="block text-sm font-medium text-slate-800 dark:text-slate-100">Remove temporary config</span>
                  <span class="mt-1 block text-xs text-slate-600 dark:text-slate-300">Strip out any temporary LCM configuration that was used during staging after the network is fully converted.</span>
                </span>
              </span>
              <span class="absolute right-3 top-3 inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-200 text-xs font-bold text-sky-700 dark:bg-sky-900 dark:text-sky-200">?</span>
              <span class="tip">Cleans up any temporary configuration left on the device once finalization completes so the LCM process can wrap up cleanly.</span>
            </label>
          </div>
          </div>
        </div>
      </div>

      <!-- Rows -->
      <div id="rows_warning" class="hidden rounded-lg border p-3 mb-3 status-error text-sm dark:bg-rose-950"></div>
      <div id="batch_rows" class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow divide-y dark:divide-slate-700"></div>

      <div class="flex items-center gap-3 mt-4">
        <button id="push_batch_btn" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Run selected automation</button>
        <div id="batch_status" class="text-sm text-slate-600 dark:text-slate-300 ml-2"></div>
      </div>

      <!-- Results -->
      <div id="batch_output" class="mt-4 space-y-4"></div>
      <div id="batch_phase_status" class="mt-4 space-y-3 hidden"></div>
    </section>
  </div>
  </div>

    <script>
      const menuBtn = document.getElementById('menu_btn');
      const menu = document.getElementById('menu');
      const main = document.getElementById('main');
      menuBtn.addEventListener('click', () => {
        menu.classList.toggle('-translate-x-full');
        main.classList.toggle('ml-64');
      });
      document.addEventListener('click', e => {
        if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
          menu.classList.add('-translate-x-full');
          main.classList.remove('ml-64');
        }
      });

    const userGreeting = document.getElementById('user_greeting');
    const logoutBtn = document.getElementById('logout_btn');

    // --- Auth status ---
    fetch('/me').then(res => {
      if (!res.ok) throw new Error('not authed');
      return res.json();
    }).then(data => {
      const user = data.user || {};
      const name = user.name || 'there';
      const readOnly = Boolean(user.read_only);
      const suffix = readOnly ? ' (read-only)' : '';
      userGreeting.textContent = `Hey ${name}!${suffix}`;
      userGreeting.classList.remove('hidden');
      logoutBtn?.classList.remove('hidden');
      logoutBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/logout';
      });

      if (readOnly) {
        liveChangeCheckboxes.forEach(cb => {
          if (!cb) return;
          cb.checked = false;
          cb.disabled = true;
          const label = cb.closest('label');
          label?.classList.add('opacity-50', 'pointer-events-none');
          label?.setAttribute('title', 'Read-only accounts cannot apply live changes.');
        });
        updateAutomationLocks();
      }
    }).catch(() => {
      window.location.href = '/login';
    });

    // --- Elements ---
    const sshDevicesInput = document.getElementById('cfg_ssh_devices');
    const sshUsernameInput = document.getElementById('cfg_ssh_username');
    const sshPasswordInput = document.getElementById('cfg_ssh_password');
    const sshToggleBtn = document.getElementById('cfg_ssh_toggle_password');
    const sshCollectBtn = document.getElementById('cfg_ssh_collect');
    const sshProgress = document.getElementById('cfg_ssh_progress');
    const sshFailurePanel = document.getElementById('cfg_ssh_failure_panel');
    const sshFailureSummary = document.getElementById('cfg_ssh_failure_summary');
    const sshFailureList = document.getElementById('cfg_ssh_failure_list');

    const dz = document.getElementById('dz');
    const fileInput = document.getElementById('file_input');
    const chooseBtn = document.getElementById('choose_files');
    const convertStatus = document.getElementById('convert_status');
    const clearAll = document.getElementById('clear_all');
    const results = document.getElementById('results');
    const resultsList = document.getElementById('results_list');

    const batchSection = document.getElementById('batch_section');
    const rowsWarning = document.getElementById('rows_warning');
    const batchRows = document.getElementById('batch_rows');
    const pushBatchBtn = document.getElementById('push_batch_btn');
    const batchStatus = document.getElementById('batch_status');
    const batchOutput = document.getElementById('batch_output');
    const batchPhaseStatus = document.getElementById('batch_phase_status');

    const strictOverflow = document.getElementById('strict_overflow');
    const tz = document.getElementById('tz');
    const modelOverride = document.getElementById('model_override');
    const applyTempConfig = document.getElementById('apply_temp_config');
    const finalizeAssignments = document.getElementById('finalize_assignments');
    const removeTempConfig = document.getElementById('remove_temp_config');
    const siteStage = document.getElementById('site_stage');
    const sitePush = document.getElementById('site_push');

    // --- Data ---
    let convertedItems = []; // [{ source_file, output_file, json }]
    let rows = []; // [{ idx, site_id, device_id, excludes, exclude_uplinks, member_offset, port_offset, model_override?, userChangedSite? }]
    let seenFiles = new Set(); // dedupe chooser/dnd
    let sitesCache = []; // list of sites
    const devicesBySite = new Map(); // site_id -> devices[]
    let sshCollectStartedAt = null;
    let sshCollectRequested = 0;
    const siteAutomationCheckboxes = [siteStage, sitePush].filter(Boolean);
    const lcmAutomationCheckboxes = [applyTempConfig, finalizeAssignments, removeTempConfig].filter(Boolean);
    const liveChangeCheckboxes = [sitePush, applyTempConfig, finalizeAssignments, removeTempConfig].filter(Boolean);

    // --- Utils ---
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function escapeHtml(str){ return String(str).replace(/[&<>'"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[c])); }

    function isPreviewOnly(){
      return !liveChangeCheckboxes.some(cb => cb && cb.checked);
    }

    function syncPushBtnLabel(){
      const preview = isPreviewOnly();
      const anySelected = siteAutomationCheckboxes.some(cb => cb && cb.checked) || lcmAutomationCheckboxes.some(cb => cb && cb.checked);
      if (!anySelected){
        pushBatchBtn.textContent = 'Run selected automation';
      } else if (preview){
        pushBatchBtn.textContent = 'Stage/test selected automation';
      } else {
        pushBatchBtn.textContent = 'Apply selected automation';
      }
    }

    function updateAutomationLocks(){
      const siteActive = siteAutomationCheckboxes.some(cb => cb && cb.checked);
      const lcmActive = lcmAutomationCheckboxes.some(cb => cb && cb.checked);

      if (siteActive){
        lcmAutomationCheckboxes.forEach(cb => { if (cb) cb.checked = false; });
      }
      if (lcmActive){
        siteAutomationCheckboxes.forEach(cb => { if (cb) cb.checked = false; });
      }

      const finalSiteActive = siteAutomationCheckboxes.some(cb => cb && cb.checked);
      const finalLcmActive = lcmAutomationCheckboxes.some(cb => cb && cb.checked);

      siteAutomationCheckboxes.forEach(cb => {
        if (!cb) return;
        const disable = finalLcmActive && !cb.checked;
        cb.disabled = disable;
        const label = cb.closest('label');
        label?.classList.toggle('opacity-50', disable);
        label?.classList.toggle('pointer-events-none', disable);
      });

      lcmAutomationCheckboxes.forEach(cb => {
        if (!cb) return;
        const disable = finalSiteActive && !cb.checked;
        cb.disabled = disable;
        const label = cb.closest('label');
        label?.classList.toggle('opacity-50', disable);
        label?.classList.toggle('pointer-events-none', disable);
      });

      syncPushBtnLabel();
      renderConvertedList();
    }

    async function logTiming(eventName, durationMs, metadata = {}){
      try {
        await fetch('/api/log_timing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event: eventName,
            duration_ms: Math.max(0, Math.round(durationMs)),
            metadata
          })
        });
      } catch (err) {
        console.warn('Failed to log timing metric', err);
      }
    }

    function resetSshFailurePanel(){
      if (!sshFailurePanel) return;
      sshFailurePanel.classList.add('hidden');
      if (sshFailureSummary) sshFailureSummary.textContent = '';
      if (sshFailureList) sshFailureList.innerHTML = '';
    }

    function renderSshFailures(failures, totalRequested){
      if (!sshFailurePanel || !sshFailureList) return;
      if (!failures?.length){
        resetSshFailurePanel();
        return;
      }

      sshFailureList.innerHTML = '';
      const totalText = totalRequested ? `Unable to collect configs from ${failures.length} of ${totalRequested} device(s).` : `Unable to collect configs from ${failures.length} device(s).`;
      if (sshFailureSummary){
        sshFailureSummary.textContent = `${totalText} Hover or tap each device for troubleshooting tips.`;
      }

      failures.forEach(item => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2 rounded-lg border border-rose-200 bg-white/70 px-3 py-2 text-sm text-rose-700 dark:border-rose-900 dark:bg-rose-900/40 dark:text-rose-100';

        const label = item.label || item.host || 'Device';
        const info = item.error_info || {};
        const reasonText = info.reason || item.error || 'Connection failed.';
        const summaryText = `${label} - ${reasonText}`;

        const textSpan = document.createElement('span');
        textSpan.className = 'flex-1';
        textSpan.textContent = summaryText;
        li.appendChild(textSpan);

        const tooltipLines = [];
        if (info.suggestion){
          tooltipLines.push(`Suggestion: ${info.suggestion}`);
        }
        if (info.detail && info.detail !== reasonText){
          tooltipLines.push(`Detail: ${info.detail}`);
        }
        const tooltipText = tooltipLines.length ? `${reasonText}\n\n${tooltipLines.join('\n')}` : reasonText;
        li.title = tooltipText;

        if (tooltipLines.length){
          const icon = document.createElement('span');
          icon.className = 'shrink-0 text-xs font-semibold uppercase tracking-wide text-rose-600 dark:text-rose-200 cursor-help';
          icon.textContent = 'Details';
          icon.title = tooltipText;
          li.appendChild(icon);
        }

        sshFailureList.appendChild(li);
      });

      sshFailurePanel.classList.remove('hidden');
    }

    const savedSshUser = localStorage.getItem('ssh_username');
    if (savedSshUser && sshUsernameInput) sshUsernameInput.value = savedSshUser;

    if (sshToggleBtn && sshPasswordInput){
      sshToggleBtn.addEventListener('click', () => {
        const hidden = sshPasswordInput.type === 'password';
        sshPasswordInput.type = hidden ? 'text' : 'password';
        sshToggleBtn.textContent = hidden ? 'Hide' : 'Show';
      });
    }

    if (sshCollectBtn){
      sshCollectBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (sshCollectBtn.disabled) return;
        const devicesRaw = (sshDevicesInput?.value || '').split(/\r?\n|,/);
        const devices = devicesRaw.map(v => v.trim()).filter(Boolean).map(host => ({ host, label: host }));
        if (!devices.length){
          convertStatus.textContent = 'Enter at least one device hostname or IP.';
          return;
        }
        const username = sshUsernameInput?.value?.trim() || '';
        const password = sshPasswordInput?.value || '';
        if (!username || !password){
          convertStatus.textContent = 'SSH username and password are required.';
          return;
        }

        resetSshFailurePanel();
        sshCollectBtn.disabled = true;
        sshCollectBtn.classList.add('opacity-70', 'cursor-not-allowed');
        if (sshProgress) sshProgress.textContent = 'Starting SSH collectionâ€¦';
        convertStatus.textContent = '';
        sshCollectStartedAt = performance.now();
        sshCollectRequested = devices.length;

        try {
          const res = await fetch('/api/ssh/jobs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, devices })
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || res.statusText || 'Failed to start job');
          localStorage.setItem('ssh_username', username);
          if (sshPasswordInput) sshPasswordInput.value = '';
          pollConfigJob(data.job_id);
        } catch (err) {
          convertStatus.textContent = 'Error starting SSH job: ' + (err?.message || err);
          sshCollectBtn.disabled = false;
          sshCollectBtn.classList.remove('opacity-70', 'cursor-not-allowed');
          if (sshProgress) sshProgress.textContent = '';
          sshCollectStartedAt = null;
          sshCollectRequested = 0;
          resetSshFailurePanel();
        }
      });
    }

    function pollConfigJob(jobId){
      let timer = null;
      const fetchStatus = async () => {
        try {
          const res = await fetch(`/api/ssh/jobs/${jobId}`);
          if (!res.ok) throw new Error(res.statusText || 'Status request failed');
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'Status error');
          const job = data.job || {};
          const updates = job.updates || [];
          if (sshProgress && job.message){
            if (updates.length){
              const last = updates[updates.length - 1];
              const detail = last?.device ? `${last.device} (${last.status})` : '';
              sshProgress.textContent = detail ? `${job.message} â€¢ ${detail}` : job.message;
            } else {
              sshProgress.textContent = job.message;
            }
          }

          if (job.status === 'complete'){
            clearInterval(timer);
            await handleConfigJobComplete(job);
            if (sshCollectBtn){
              sshCollectBtn.disabled = false;
              sshCollectBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
            if (sshProgress) sshProgress.textContent = '';
          }
        } catch (err) {
          clearInterval(timer);
          convertStatus.textContent = 'Error retrieving SSH status: ' + (err?.message || err);
          if (sshCollectBtn){
            sshCollectBtn.disabled = false;
            sshCollectBtn.classList.remove('opacity-70', 'cursor-not-allowed');
          }
          if (sshProgress) sshProgress.textContent = '';
          sshCollectStartedAt = null;
          sshCollectRequested = 0;
          resetSshFailurePanel();
        }
      };
      fetchStatus();
      timer = setInterval(fetchStatus, 1500);
    }

    async function handleConfigJobComplete(job){
      const resultsArr = job.results || [];
      const successes = resultsArr.filter(r => r.status === 'ok' && r.running_config && r.running_config.text);
      const failures = resultsArr.filter(r => r.status !== 'ok');
      const totalDevices = Number(job?.total || 0) || (successes.length + failures.length) || sshCollectRequested || 0;

      if (!successes.length){
        if (failures.length){
          convertStatus.textContent = `SSH collection failed for ${failures.length} device(s). Hover over the entries below for tips.`;
        } else {
          convertStatus.textContent = 'No configs collected via SSH.';
        }
        sshCollectStartedAt = null;
        sshCollectRequested = 0;
        renderSshFailures(failures, totalDevices);
        return;
      }

      const now = Date.now();
      const files = successes.map(item => {
        const text = item.running_config?.text || '';
        let filename = item.running_config?.filename || '';
        if (!filename){
          const base = (item.label || item.host || 'config').replace(/[^A-Za-z0-9._-]+/g, '_') || 'config';
          filename = `${base}.running-config.txt`;
        }
        return new File([text], filename, { type: 'text/plain', lastModified: now });
      });

      if (files.length){
        await handleFiles(files);
        if (sshCollectStartedAt !== null){
          const duration = performance.now() - sshCollectStartedAt;
          logTiming('config_fetch_results', duration, {
            devices_requested: sshCollectRequested,
            successes: successes.length,
            failures: failures.length
          });
        }
      }

      sshCollectStartedAt = null;
      sshCollectRequested = 0;

      renderSshFailures(failures, totalDevices);
      if (failures.length){
        convertStatus.textContent += ` ${failures.length} device(s) failed â€“ hover over the entries below for tips.`;
        console.warn('SSH config collection failures:', failures);
      }
    }

    // --- File input UX (Chrome/Edge: single dialog & same-file reselect) ---
    chooseBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      fileInput.value = '';
      fileInput.click();
    });
    dz.addEventListener('click', (e) => {
      if (e.target === dz) { fileInput.value = ''; fileInput.click(); }
    });
    dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('dragover'); if (e.dataTransfer.files?.length) handleFiles([...e.dataTransfer.files]); });
    fileInput.addEventListener('change', () => { handleFiles([...fileInput.files]); fileInput.value = ''; });

    clearAll.addEventListener('click', () => {
      convertedItems = [];
      rows = [];
      seenFiles.clear();
      resultsList.innerHTML = '';
      batchRows.innerHTML = '';
      batchOutput.innerHTML = '';
      convertStatus.textContent = '';
      hide(results);
      hide(batchSection);
      hide(rowsWarning);
      batchStatus.textContent = '';
      syncPushBtnLabel();
      resetSshFailurePanel();
    });

    // --- Sites/Devices ---
    async function fetchSites(){
      try {
        const res = await fetch('/api/sites');
        const data = await res.json();
        if (!data.ok) throw new Error(JSON.stringify(data.error));
        sitesCache = data.items || [];
      } catch (e){
        sitesCache = [];
        console.error('Failed to fetch sites', e);
      }
    }
    async function fetchDevices(site_id){
      if (!site_id) return [];
      if (devicesBySite.has(site_id)) return devicesBySite.get(site_id);
      try {
        const url = new URL('/api/site_devices', window.location.origin);
        url.searchParams.set('site_id', site_id);
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) throw new Error(JSON.stringify(data.error));
        devicesBySite.set(site_id, data.items || []);
        return data.items || [];
      } catch (e){
        console.error('Failed to fetch devices', e);
        devicesBySite.set(site_id, []);
        return [];
      }
    }

    // --- Conversion ---
    function keyForFile(f){ return `${f.name}|${f.size}|${f.lastModified}`; }

    async function handleFiles(files){
      if (!files.length) return;

      // dedupe files
      const unique = [];
      for (const f of files){
        const key = keyForFile(f);
        if (!seenFiles.has(key)) { seenFiles.add(key); unique.push(f); }
      }
      if (!unique.length){ convertStatus.textContent = 'All selected files were duplicates.'; return; }

      convertStatus.textContent = 'Converting...';
      const form = new FormData();
      unique.forEach(f => form.append('files', f));
      form.append('strict_overflow', strictOverflow.checked ? 'true' : 'false');

      const res = await fetch('/api/convert', { method: 'POST', body: form });
      const data = await res.json();
      if (!data.ok){
        convertStatus.textContent = `Error: ${data.error || res.status}`;
        return;
      }
      (data.items || []).forEach(it => convertedItems.push(it));
      renderConvertedList();
      convertStatus.textContent = `Converted ${data.items.length} file(s). Total: ${convertedItems.length}.`;

      if (!sitesCache.length) await fetchSites();

      // New rows: site defaults to first row's site if exists, else first site in list
      const defaultSite = rows.length ? rows[0].site_id : (sitesCache[0]?.id || '');
      for (let i = rows.length; i < convertedItems.length; i++){
        rows.push({
          idx: i,
          site_id: defaultSite || '',
          device_id: '',
          excludes: '',
          exclude_uplinks: true,
          member_offset: 0,
          port_offset: 0,
          model_override: '',
          userChangedSite: false
        });
        if (defaultSite) await fetchDevices(defaultSite);
      }

      renderBatchRows();
      show(batchSection);
    }

    function renderConvertedList(){
      if (!convertedItems.length){
        hide(results);
        resultsList.innerHTML = '';
        return;
      }
      show(results);
      resultsList.innerHTML = '';
      convertedItems.forEach((it, idx) => {
        const card = document.createElement('div');
        card.className = 'rounded-xl border bg-white dark:bg-slate-800 dark:border-slate-700 p-4';
        const siteAutomationActive = siteAutomationCheckboxes.some(cb => cb && cb.checked);
        const lcmActive = lcmAutomationCheckboxes.some(cb => cb && cb.checked);
        const showConversionPreview = siteAutomationActive || (!siteAutomationActive && !lcmActive);
        const previewSection = showConversionPreview
          ? `<details class="mt-2">
              <summary class="cursor-pointer text-sm text-slate-600 dark:text-slate-300">Preview JSON</summary>
              <pre class="text-xs mt-2 p-2 bg-slate-50 dark:bg-slate-900/60 border dark:border-slate-700 rounded overflow-auto max-h-80">${escapeHtml(JSON.stringify(it.json, null, 2))}</pre>
            </details>`
          : `<p class="mt-2 text-xs text-slate-600 dark:text-slate-300">Run a test with Lifecycle automation enabled to review the Mist request that stages VLANs, port profiles, and switchport assignments for the existing network.</p>`;
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${escapeHtml(it.source_file)}</div>
            <div class="text-xs text-slate-500 dark:text-slate-300">Row ${idx+1}</div>
          </div>
          ${previewSection}
        `;
        resultsList.appendChild(card);
      });
    }

    // --- Batch rows UI ---
    function siteOptionsHtml(selectedId){
      const opts = ['<option value="">Select a siteâ€¦</option>'];
      sitesCache.forEach(s => {
        const sel = (s.id === selectedId) ? 'selected' : '';
        const shortId = s.id ? s.id.slice(0,8) : '';
        opts.push(`<option value="${s.id}" ${sel}>${escapeHtml(s.name)}${shortId ? ' ('+shortId+')' : ''}</option>`);
      });
      return opts.join('');
    }
    function deviceOptionsHtml(site_id, selectedId){
      const devs = devicesBySite.get(site_id) || [];
      const opts = ['<option value="">Select a deviceâ€¦</option>'];
      devs.forEach(d => {
        const label = `${d.name} â€” ${d.model || ''} ${d.type ? `(${d.type})` : ''}`.trim();
        const sel = (d.id === selectedId) ? 'selected' : '';
        opts.push(`<option value="${d.id}" ${sel}>${escapeHtml(label)}</option>`);
      });
      return opts.join('');
    }

    function renderBatchRows(){
      batchRows.innerHTML = '';
      rows.forEach((row, i) => {
        const dup = isPairDuplicate(row.device_id, row.member_offset, row.port_offset);
        const dupClass = dup ? 'ring-2 ring-rose-500' : '';
        const el = document.createElement('div');
        el.className = 'p-4';
        el.innerHTML = `
          <div class="grid md:grid-cols-12 gap-2 items-end">
            <div class="md:col-span-1">
              <label class="block text-xs font-medium mb-1">File</label>
              <div class="text-sm text-slate-700 dark:text-slate-200 truncate" title="${escapeHtml(convertedItems[row.idx]?.source_file || '')}">
                ${escapeHtml(convertedItems[row.idx]?.source_file || '(missing)')}
              </div>
            </div>

            <div class="md:col-span-3">
              <label class="block text-xs font-medium mb-1">Site</label>
              <select data-rowsel="site" data-row="${i}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700">${siteOptionsHtml(row.site_id)}</select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-medium mb-1">Device</label>
              <select data-rowsel="device" data-row="${i}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700 ${dupClass}">
                ${row.site_id ? deviceOptionsHtml(row.site_id, row.device_id) : '<option value="">Select a site first</option>'}
              </select>
            </div>

          <div class="md:col-span-1">
              <label class="block text-xs font-medium mb-1 tooltip">
                <span class="inline-flex items-center gap-1">Start member
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
                </span>
                <span class="tip">Offset Cisco member numbering when mapping to a Juniper VC. Example: two 48-port Cisco stacks become a single 5-member VCâ€”set rows destined for members 0,1,2,3,4 accordingly.</span>
              </label>
              <input data-rowsel="offset" data-row="${i}" type="number" min="0" step="1" value="${row.member_offset}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700 ${dupClass}" />
            </div>

            <div class="md:col-span-1">
              <label class="block text-xs font-medium mb-1 tooltip">
                <span class="inline-flex items-center gap-1">Start port
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
                </span>
                <span class="tip">Shift port numbering within a member. Example: two 24-port switches forming one 48-port deviceâ€”set the second row to Start port 24 so its ports map to 24â€“47.</span>
              </label>
              <input data-rowsel="port" data-row="${i}" type="number" min="0" step="1" value="${row.port_offset}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700 ${dupClass}" />
            </div>

            <div class="md:col-span-3">
              <label class="block text-xs font-medium mb-1 tooltip">
                <span class="inline-flex items-center gap-1">Exclude interfaces
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
                </span>
                <span class="tip">Skip specific interfaces from being pushed (e.g., uplinks or special ports). Use full Juniper names, comma-separated. Ranges like <code>xe-0/2/[0-3]</code> are supported.</span>
              </label>
              <div class="flex items-center gap-2 mb-1">
                <input data-rowsel="exclude_uplinks" data-row="${i}" type="checkbox" class="w-4 h-4" ${row.exclude_uplinks ? 'checked' : ''} />
                <span class="text-sm">Exclude uplinks</span>
              </div>
              <input data-rowsel="excludes" data-row="${i}" type="text" placeholder="ge-0/2/0, xe-0/2/1" value="${escapeHtml(row.excludes)}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" />
            </div>

            <div class="md:col-span-1 flex items-end justify-end">
              <button class="h-9 w-9 flex items-center justify-center rounded border border-rose-500 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/30" title="Remove row" data-rowremove="${i}">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 8.586l3.536-3.536 1.414 1.414L11.414 10l3.536 3.536-1.414 1.414L10 11.414l-3.536 3.536-1.414-1.414L8.586 10 5.05 6.464l1.414-1.414L10 8.586z" clip-rule="evenodd"/></svg>
              </button>
            </div>
          </div>
        `;
        batchRows.appendChild(el);
      });

      // listeners
      batchRows.querySelectorAll('select[data-rowsel="site"]').forEach(sel => {
        sel.addEventListener('change', async () => {
          const i = parseInt(sel.getAttribute('data-row'));
          const oldFirst = rows[0]?.site_id || '';
          rows[i].site_id = sel.value;
          rows[i].device_id = '';
          rows[i].userChangedSite = true;

          if (rows[i].site_id) await fetchDevices(rows[i].site_id);
          updateDeviceSelect(i);
          updatePairDuplicateWarning();

          // Propagate from first row to others (only rows not manually changed)
          if (i === 0 && sel.value !== oldFirst) {
            await propagateFirstSite(rows[0].site_id);
          }
        });
      });
      batchRows.querySelectorAll('select[data-rowsel="device"]').forEach(sel => {
        sel.addEventListener('change', () => {
          const i = parseInt(sel.getAttribute('data-row'));
          rows[i].device_id = sel.value;
          updatePairDuplicateWarning();
          markPairDuplicateClass(i);
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="offset"]').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          const v = parseInt(inp.value || '0'); rows[i].member_offset = isNaN(v) ? 0 : Math.max(0, v);
          updatePairDuplicateWarning();
          markPairDuplicateClass(i);
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="port"]').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          const v = parseInt(inp.value || '0'); rows[i].port_offset = isNaN(v) ? 0 : Math.max(0, v);
          updatePairDuplicateWarning();
          markPairDuplicateClass(i);
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="excludes"]').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          rows[i].excludes = inp.value || '';
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="exclude_uplinks"]').forEach(inp => {
        inp.addEventListener('change', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          rows[i].exclude_uplinks = inp.checked;
        });
      });
      batchRows.querySelectorAll('button[data-rowremove]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.getAttribute('data-rowremove'));
          rows.splice(i, 1);
          renderBatchRows();
          updatePairDuplicateWarning();
        });
      });

      updatePairDuplicateWarning();
    }

    // Propagate first row's Site to rows that were NOT manually changed
    async function propagateFirstSite(newSiteId){
      if (!newSiteId) return;
      await fetchDevices(newSiteId); // prime cache
      for (let j = 1; j < rows.length; j++){
        if (!rows[j].userChangedSite) {
          rows[j].site_id = newSiteId;
          rows[j].device_id = '';
          updateSiteSelect(j);
          updateDeviceSelect(j);
        }
      }
    }

    function updateSiteSelect(i){
      const row = rows[i];
      const sel = batchRows.querySelector(`select[data-rowsel="site"][data-row="${i}"]`);
      if (!sel) return;
      sel.innerHTML = siteOptionsHtml(row.site_id);
    }
    function updateDeviceSelect(i){
      const row = rows[i];
      const sel = batchRows.querySelector(`select[data-rowsel="device"][data-row="${i}"]`);
      if (!sel) return;
      if (!row.site_id) { sel.innerHTML = '<option value="">Select a site first</option>'; return; }
      sel.innerHTML = deviceOptionsHtml(row.site_id, row.device_id);
      markPairDuplicateClass(i);
    }

    // Duplicate logic: allow same device multiple times if Start member/Start port differ
    function isPairDuplicate(device_id, member_offset, port_offset){
      if (!device_id) return false;
      const key = `${device_id}@@${member_offset}@@${port_offset}`;
      let seen = 0;
      for (const r of rows){
        if (r.device_id && `${r.device_id}@@${r.member_offset}@@${r.port_offset}` === key) {
          seen += 1;
          if (seen > 1) return true;
        }
      }
      return false;
    }
    function updatePairDuplicateWarning(){
      let hasDup = false;
      const counter = new Map();
      for (const r of rows){
        if (!r.device_id) continue;
        const key = `${r.device_id}@@${r.member_offset}@@${r.port_offset}`;
        counter.set(key, (counter.get(key) || 0) + 1);
      }
      for (const count of counter.values()){
        if (count > 1) { hasDup = true; break; }
      }
      if (hasDup){
        rowsWarning.innerHTML = 'Duplicate device with the same <em>Start member</em> and <em>Start port</em> detected. Use different offsets for repeated device selections.';
        show(rowsWarning);
        pushBatchBtn.disabled = true;
        pushBatchBtn.classList.add('cursor-not-allowed','opacity-70');
      } else {
        hide(rowsWarning);
        pushBatchBtn.disabled = false;
        pushBatchBtn.classList.remove('cursor-not-allowed','opacity-70');
      }
      rows.forEach((_, i) => markPairDuplicateClass(i));
    }
    function markPairDuplicateClass(i){
      const row = rows[i];
      const devSel = batchRows.querySelector(`select[data-rowsel="device"][data-row="${i}"]`);
      const offInp = batchRows.querySelector(`input[data-rowsel="offset"][data-row="${i}"]`);
      const portInp = batchRows.querySelector(`input[data-rowsel="port"][data-row="${i}"]`);
      const dup = isPairDuplicate(row.device_id, row.member_offset, row.port_offset);
      [devSel, offInp, portInp].forEach(el => {
        if (!el) return;
        el.classList.toggle('ring-2', dup);
        el.classList.toggle('ring-rose-500', dup);
      });
    }

    // --- Batch push ---
    syncPushBtnLabel();

    function renderPhaseStatus(statusMap){
      batchPhaseStatus.innerHTML = '';
      if (!statusMap || typeof statusMap !== 'object' || !Object.keys(statusMap).length){
        hide(batchPhaseStatus);
        return;
      }

      const labelMap = {
        site_stage: 'Site Deployment Â· Stage/Test converted config',
        site_push: 'Site Deployment Â· Push converted config',
        apply_temporary_config: 'LCM Step 1 Â· Stage temporary config',
        finalize_assignments: 'LCM Step 2 Â· Finalize assignments',
        remove_temporary_config: 'LCM Step 3 Â· Remove temporary config'
      };

      Object.entries(statusMap).forEach(([key, info]) => {
        const label = labelMap[key] || key;
        const ok = Boolean(info?.ok);
        const skipped = Boolean(info?.skipped);
        const failures = Array.isArray(info?.failures) ? info.failures : [];
        const message = info?.message ? escapeHtml(String(info.message)) : '';
        const total = typeof info?.total === 'number' ? info.total : undefined;
        const successes = typeof info?.successes === 'number' ? info.successes : undefined;
        const payloads = Array.isArray(info?.payloads) ? info.payloads : [];

        const card = document.createElement('div');
        const baseClass = skipped ? 'status-info dark:bg-slate-800/60' : ok ? 'status-success dark:bg-emerald-900/40' : 'status-error dark:bg-rose-950';
        card.className = `rounded-lg border p-4 text-sm ${baseClass}`;

        const meta = [];
        if (typeof successes === 'number' && typeof total === 'number'){
          meta.push(`${successes}/${total} device${total === 1 ? '' : 's'} processed`);
        }

        const header = document.createElement('div');
        header.className = 'font-semibold mb-1 flex items-center justify-between gap-2';
        header.innerHTML = `<span>${escapeHtml(label)}</span>` + (meta.length ? `<span class="text-xs font-normal text-slate-600 dark:text-slate-300">${escapeHtml(meta.join(' â€¢ '))}</span>` : '');
        card.appendChild(header);

        if (message){
          const msgEl = document.createElement('div');
          msgEl.className = 'mb-2';
          msgEl.innerHTML = message;
          card.appendChild(msgEl);
        }

        if (failures.length){
          const list = document.createElement('ul');
          list.className = 'space-y-1 text-xs';
          failures.forEach(f => {
            const site = f?.site_id ? `Site ${escapeHtml(String(f.site_id))}` : '';
            const device = f?.device_id ? `Device ${escapeHtml(String(f.device_id))}` : '';
            const statusText = typeof f?.status === 'number' ? ` (HTTP ${f.status})` : '';
            const context = [site, device].filter(Boolean).join(' â€¢ ');
            const detail = f?.message ? escapeHtml(String(f.message)) : 'Unknown error';
            const line = document.createElement('li');
            line.innerHTML = `${context ? `${context}: ` : ''}${detail}${statusText}`;
            list.appendChild(line);
          });
          card.appendChild(list);
        }

        if (payloads.length){
          const details = document.createElement('details');
          details.className = 'mt-3';
          const summaryLabel = key === 'apply_temporary_config'
            ? 'Temporary config payloads sent to Mist'
            : 'Request payloads';
          details.innerHTML = `<summary class="cursor-pointer text-xs text-slate-600 dark:text-slate-300">${escapeHtml(summaryLabel)}</summary>`;

          const payloadWrap = document.createElement('div');
          payloadWrap.className = 'mt-2 space-y-3';

          payloads.forEach(item => {
            const site = item?.site_id ? `Site ${escapeHtml(String(item.site_id))}` : '';
            const device = item?.device_id ? `Device ${escapeHtml(String(item.device_id))}` : '';
            const headerParts = [site, device].filter(Boolean).join(' â€¢ ');
            const payloadPre = document.createElement('pre');
            payloadPre.className = 'text-xs p-2 bg-white dark:bg-slate-900/60 border dark:border-slate-700 rounded overflow-auto max-h-80';
            payloadPre.textContent = JSON.stringify(item?.payload ?? {}, null, 2);

            const block = document.createElement('div');
            block.className = 'rounded-lg border dark:border-slate-700 bg-white/70 dark:bg-slate-900/50 p-2';
            block.innerHTML = headerParts
              ? `<div class="text-xs font-medium mb-1 text-slate-600 dark:text-slate-300">${headerParts}</div>`
              : '';
            block.appendChild(payloadPre);
            payloadWrap.appendChild(block);
          });

          details.appendChild(payloadWrap);
          card.appendChild(details);
        }

        batchPhaseStatus.appendChild(card);
      });

      show(batchPhaseStatus);
    }

    pushBatchBtn.addEventListener('click', async () => {
      batchOutput.innerHTML = '';
      batchStatus.textContent = '';
      renderPhaseStatus({});

      for (const r of rows){
        if (!r.site_id || !r.device_id){
          alert('Each row must have a Site and a Device selected.');
          return;
        }
      }
      if (pushBatchBtn.disabled) return;

      const previewOnly = isPreviewOnly();

      const payloadRows = rows.map(r => ({
        site_id: r.site_id,
        device_id: r.device_id,
        input_json: convertedItems[r.idx].json,
        excludes: r.excludes,
        exclude_uplinks: r.exclude_uplinks,
        member_offset: r.member_offset,
        port_offset: r.port_offset,
        model_override: r.model_override || ''
      }));

      const form = new FormData();
      form.append('rows', JSON.stringify(payloadRows));
      form.append('tz', tz.value.trim());
      const mo = (modelOverride.value || '').trim();
      if (mo) form.append('model_override', mo);
      form.append('apply_temp_config', applyTempConfig?.checked ? 'true' : 'false');
      form.append('finalize_assignments', finalizeAssignments?.checked ? 'true' : 'false');
      form.append('remove_temp_config', removeTempConfig?.checked ? 'true' : 'false');
      form.append('stage_site_deployment', siteStage?.checked ? 'true' : 'false');
      form.append('push_site_deployment', sitePush?.checked ? 'true' : 'false');

      pushBatchBtn.disabled = true;
      pushBatchBtn.textContent = previewOnly ? 'Stagingâ€¦' : 'Applyingâ€¦';

      try {
        const res = await fetch('/api/push_batch', { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok){
          throw new Error(data?.error || `Request failed with status ${res.status}`);
        }

        const okCount = (data.results || []).filter(r => r.ok).length;
        const total = (data.results || []).length;
        const siteActive = siteAutomationCheckboxes.some(cb => cb && cb.checked);
        const lcmActive = lcmAutomationCheckboxes.some(cb => cb && cb.checked);
        if (siteActive){
          const label = previewOnly ? 'stage/test run' : 'push';
          batchStatus.textContent = `${okCount}/${total} ${label}${total === 1 ? '' : 's'} succeeded.`;
        } else if (lcmActive){
          batchStatus.textContent = `${okCount}/${total} configs ready for Lifecycle automation.`;
        } else {
          batchStatus.textContent = `${okCount}/${total} rows processed.`;
        }

        renderBatchResults(data.results || []);
        renderPhaseStatus(data.phase_status || {});

      } catch (e){
        batchOutput.innerHTML = `
          <div class="rounded-lg border p-3 status-error dark:bg-rose-950">
            <div class="font-medium">Unexpected error</div>
            <div class="text-sm mt-1">${escapeHtml(String(e))}</div>
          </div>`;
        batchStatus.textContent = '';
        renderPhaseStatus({});
      } finally {
        pushBatchBtn.disabled = false;
        syncPushBtnLabel();
      }
    });

    function renderBatchResults(results){
      batchOutput.innerHTML = '';
      const showSiteOutputs = siteAutomationCheckboxes.some(cb => cb && cb.checked);
      if (!showSiteOutputs){
        if (results.length){
          batchOutput.innerHTML = `
            <div class="rounded-lg border border-slate-200 bg-white p-3 text-sm dark:border-slate-700 dark:bg-slate-900/60">
              <div class="font-medium text-slate-700 dark:text-slate-200">Site Deployment automation not selected</div>
              <div class="mt-1 text-slate-600 dark:text-slate-300">Review the Lifecycle automation status cards above for the Mist payloads generated during this run.</div>
            </div>`;
        }
        return;
      }
      results.forEach((r, i) => {
        const fileLabel = convertedItems[rows[r.row_index]?.idx || 0]?.source_file || `Row ${i+1}`;
        const statusBadge = r.ok
          ? '<span class="inline-block px-2 py-0.5 text-xs rounded bg-emerald-100 text-emerald-800">OK</span>'
          : '<span class="inline-block px-2 py-0.5 text-xs rounded bg-rose-100 text-rose-800">Failed</span>';

        const warnings = (r.validation && Array.isArray(r.validation.warnings)) ? r.validation.warnings : [];
        const errors   = (r.validation && Array.isArray(r.validation.errors))   ? r.validation.errors   : [];
        let metaHtml = '';
        if (warnings.length || errors.length) {
          const items = []
            .concat(errors.map(e => `<li class="text-rose-700">â€¢ ${escapeHtml(String(e))}</li>`))
            .concat(warnings.map(w => `<li class="text-amber-700">â€¢ ${escapeHtml(String(w))}</li>`))
            .join('');
          metaHtml = `
            <div class="rounded-lg border p-3 mb-3 ${errors.length ? 'status-error dark:bg-rose-950' : 'status-info dark:bg-slate-800/60'}">
              <div class="font-medium">${errors.length ? 'Issues detected' : 'Warnings'}</div>
              <ul class="mt-1 text-sm">${items}</ul>
            </div>
          `;
        }

        const payloadStr = escapeHtml(JSON.stringify(r.payload || {}, null, 2));
        const mistResp = (!r.dry_run && r.response) ? `
          <details class="mt-3">
            <summary class="cursor-pointer text-sm text-slate-600 dark:text-slate-300">Mist API response</summary>
            <pre class="text-xs mt-2 p-2 bg-white dark:bg-slate-900/60 border dark:border-slate-700 rounded overflow-auto max-h-96">${escapeHtml(JSON.stringify(r.response, null, 2))}</pre>
          </details>` : '';

        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl border p-4';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${escapeHtml(fileLabel)}</div>
            <div class="text-xs text-slate-600 dark:text-slate-300 flex items-center gap-2">
              <span>Site: ${escapeHtml(r.site_id || '')}</span>
              <span>Device: ${escapeHtml(r.device_id || '')}</span>
              ${statusBadge}
            </div>
          </div>
          ${metaHtml}
          <div class="rounded-lg border dark:border-slate-700 p-3 bg-white dark:bg-slate-800">
            <div class="text-sm font-medium mb-2">Payload to Mist</div>
            <pre class="text-xs p-2 bg-slate-50 dark:bg-slate-900/60 border dark:border-slate-700 rounded overflow-auto max-h-96">${payloadStr}</pre>
          </div>
          ${mistResp}
        `;
        batchOutput.appendChild(card);
      });
    }

    siteAutomationCheckboxes.forEach(cb => {
      cb?.addEventListener('change', () => {
        if (!cb) return;
        if (cb === siteStage && cb.checked && sitePush){
          sitePush.checked = false;
        }
        if (cb === sitePush && cb.checked && siteStage){
          siteStage.checked = false;
        }
        updateAutomationLocks();
      });
    });

    lcmAutomationCheckboxes.forEach(cb => {
      cb?.addEventListener('change', () => {
        updateAutomationLocks();
      });
    });

    // --- Init ---
    window.addEventListener('load', async () => {
      await fetchSites();
      syncPushBtnLabel();
      updateAutomationLocks();
    });

  </script>
</body>
</html>
