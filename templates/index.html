<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{DOC_TITLE}}</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'media' };</script>

  <style>
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color: #60a5fa; background: #f8fafc; }
    pre { white-space: pre-wrap; word-wrap: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .status-info { border-color: #bae6fd; background: #ecfeff; }
    .status-success { border-color: #86efac; background: #f0fdf4; }
    .status-error { border-color: #fecaca; background: #fef2f2; }
    .tooltip { position: relative; display: inline-flex; align-items: center; gap: .35rem; }
    .tooltip .tip {
      visibility: hidden; opacity: 0; transition: opacity .15s ease;
      position: absolute; left: 50%; transform: translateX(-50%);
      bottom: 130%; min-width: 18rem; max-width: 28rem;
      background: #0f172a; color: #f8fafc; padding: .5rem .75rem; border-radius: .5rem; font-size: .75rem;
      box-shadow: 0 10px 25px rgba(2,6,23,0.25); z-index: 50; text-align: left;
    }
    .tooltip:hover .tip { visibility: visible; opacity: 1; }
  </style>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 overflow-x-hidden">
    <nav id="menu" class="fixed inset-y-0 left-0 w-64 bg-white text-slate-900 dark:bg-slate-800 dark:text-slate-100 transform -translate-x-full transition-transform duration-300 z-50 shadow-lg p-4 space-y-2">
      <p id="user_greeting" class="hidden px-4 py-2 font-semibold"></p>
      <a href="/hardware" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_HARDWARE}}</a>
      <a href="/replacements" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_REPLACEMENTS}}</a>
      <a href="/" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_CONFIG}}</a>
      <a href="/rules" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_RULES}}</a>
      <a href="{{HELP_URL}}" target="_blank" rel="noopener" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Help</a>
      <button id="logout_btn" class="hidden w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Log out</button>
    </nav>
    <div id="main" class="transition-all duration-300">
    <header class="mb-6 bg-gradient-to-r from-emerald-500 to-sky-500 text-white shadow-lg">
      <div class="max-w-7xl mx-auto flex items-center gap-4 p-6">
        <button id="menu_btn" class="p-2 rounded hover:bg-white/30" aria-label="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex items-center gap-4">
          <img src="/static/logo.png" alt="Logo" class="h-16 w-16" />
          <div>
            <h1 class="text-3xl font-bold">{{BANNER_TITLE}}</h1>
            <p class="text-slate-100 text-sm md:text-base">{{BANNER_TAGLINE}}</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto p-6">
      <!-- Remote collection -->
      <section class="mb-6">
        <div class="rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 p-6 shadow space-y-4">
          <div>
            <h2 class="text-lg font-medium">Collect running-configs from switches</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">Enter one hostname or IP address per line. Credentials are used once per request and are not stored.</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="host_list">Switch hostnames or IPs</label>
            <textarea id="host_list" class="w-full border rounded-lg p-3 h-32 resize-y dark:bg-slate-900 dark:border-slate-700" placeholder="switch1.example.com&#10;10.0.0.2"></textarea>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1" for="ssh_username">SSH username</label>
              <input id="ssh_username" type="text" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" autocomplete="username" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1" for="ssh_password">SSH password</label>
              <div class="relative">
                <input id="ssh_password" type="password" class="w-full border rounded p-2 pr-10 dark:bg-slate-900 dark:border-slate-700" autocomplete="current-password" />
                <button type="button" id="toggle_password" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" aria-label="Toggle password visibility">
                  <svg id="toggle_password_icon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c1.5-4 5.25-6.75 9.75-6.75S20.25 8 21.75 12c-1.5 4-5.25 6.75-9.75 6.75S3.75 16 2.25 12z" />
                    <circle cx="12" cy="12" r="2.25" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-between flex-col md:flex-row gap-3">
            <div id="convert_status" class="flex-1 text-sm text-slate-600 dark:text-slate-300"></div>
            <div class="flex items-center gap-2">
              <button id="collect_hosts" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Collect configs</button>
              <button id="clear_all" class="px-4 py-2 rounded bg-rose-600 text-white hover:bg-rose-700">Clear</button>
            </div>
          </div>
        </div>
      </section>

    <!-- Converted JSON -->
    <section id="results" class="hidden mb-8">
      <h2 class="text-lg font-medium mb-2">Converted JSON Preview</h2>
      <div id="results_list" class="space-y-4"></div>
    </section>

    <!-- Batch Push -->
    <section id="batch_section" class="hidden">
      <h2 class="text-lg font-medium mb-2">Batch: Map files to switches</h2>

      <!-- Global options -->
      <div class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-4 mb-4">
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Time zone</label>
            <input id="tz" type="text" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" value="America/New_York" readonly />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Model override (optional, applies to rows without their own override)</label>
            <input id="model_override" type="text" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" placeholder="EX4100-48MP" />
          </div>
          <div class="flex items-center gap-6 mt-6 md:mt-0">
            <label class="tooltip">
              <span class="inline-flex items-center gap-2">
                <input id="dry_run" type="checkbox" class="w-4 h-4" checked />
                <span class="text-sm">Test mode (no changes)</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
              <span class="tip">Sends the exact payload to Mist <em>without</em> applying changes. You’ll see the JSON and any warnings, but devices aren’t modified.</span>
            </label>

            <label class="tooltip">
              <span class="inline-flex items-center gap-2">
                <input id="strict_overflow" type="checkbox" class="w-4 h-4" />
                <span class="text-sm">Strict overflow (convert)</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
              <span class="tip">If checked during conversion, any interface that can’t be mapped cleanly (e.g., out-of-range module/port) is dropped instead of guessed.</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Rows -->
      <div id="rows_warning" class="hidden rounded-lg border p-3 mb-3 status-error text-sm dark:bg-rose-950"></div>
      <div id="batch_rows" class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow divide-y dark:divide-slate-700"></div>

      <div class="flex items-center gap-3 mt-4">
        <button id="push_batch_btn" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Test configuration for all</button>
        <div id="batch_status" class="text-sm text-slate-600 dark:text-slate-300 ml-2"></div>
      </div>

      <!-- Results -->
      <div id="batch_output" class="mt-4 space-y-4"></div>
    </section>
  </div>
  </div>

    <script>
      const menuBtn = document.getElementById('menu_btn');
      const menu = document.getElementById('menu');
      const main = document.getElementById('main');
      menuBtn.addEventListener('click', () => {
        menu.classList.toggle('-translate-x-full');
        main.classList.toggle('ml-64');
      });
      document.addEventListener('click', e => {
        if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
          menu.classList.add('-translate-x-full');
          main.classList.remove('ml-64');
        }
      });

    const userGreeting = document.getElementById('user_greeting');
    const logoutBtn = document.getElementById('logout_btn');

    // --- Auth status ---
    fetch('/me').then(res => {
      if (!res.ok) throw new Error('not authed');
      return res.json();
    }).then(data => {
      userGreeting.textContent = `Hey ${data.user.name}!`;
      userGreeting.classList.remove('hidden');
      logoutBtn?.classList.remove('hidden');
      logoutBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/logout';
      });
    }).catch(() => {
      window.location.href = '/login';
    });

    // --- Elements ---
    const hostInput = document.getElementById('host_list');
    const usernameInput = document.getElementById('ssh_username');
    const passwordInput = document.getElementById('ssh_password');
    const togglePassword = document.getElementById('toggle_password');
    const togglePasswordIcon = document.getElementById('toggle_password_icon');
    const collectBtn = document.getElementById('collect_hosts');
    const convertStatus = document.getElementById('convert_status');
    const clearAll = document.getElementById('clear_all');
    const results = document.getElementById('results');
    const resultsList = document.getElementById('results_list');

    const batchSection = document.getElementById('batch_section');
    const rowsWarning = document.getElementById('rows_warning');
    const batchRows = document.getElementById('batch_rows');
    const pushBatchBtn = document.getElementById('push_batch_btn');
    const batchStatus = document.getElementById('batch_status');
    const batchOutput = document.getElementById('batch_output');

    const strictOverflow = document.getElementById('strict_overflow');
    const dryRun = document.getElementById('dry_run');
    const tz = document.getElementById('tz');
    const modelOverride = document.getElementById('model_override');

    // --- Data ---
    let convertedItems = []; // [{ source_file, output_file, json }]
    let rows = []; // [{ idx, site_id, device_id, excludes, exclude_uplinks, member_offset, port_offset, model_override?, userChangedSite? }]
    let sitesCache = []; // list of sites
    const devicesBySite = new Map(); // site_id -> devices[]

    // --- Utils ---
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function escapeHtml(str){ return String(str).replace(/[&<>'"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[c])); }

    const eyeOpen = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c1.5-4 5.25-6.75 9.75-6.75S20.25 8 21.75 12c-1.5 4-5.25 6.75-9.75 6.75S3.75 16 2.25 12z"></path><circle cx="12" cy="12" r="2.25"></circle>';
    const eyeClosed = '<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.75 12c1.5 4 5.25 6.75 9.75 6.75 1.603 0 3.115-.332 4.48-.927M6.228 6.228A10.46 10.46 0 0112 5.25c4.5 0 8.25 2.75 9.75 6.75a10.523 10.523 0 01-2.03 3.173M6.228 6.228L3 3m3.228 3.228l11.544 11.544"></path><path stroke-linecap="round" stroke-linejoin="round" d="M9.88 9.88a2.25 2.25 0 003.182 3.182"></path>';

    function setPasswordIcon(isVisible){
      if (!togglePasswordIcon) return;
      togglePasswordIcon.innerHTML = isVisible ? eyeClosed : eyeOpen;
    }

    togglePassword?.addEventListener('click', () => {
      if (!passwordInput) return;
      const showing = passwordInput.type === 'text';
      passwordInput.type = showing ? 'password' : 'text';
      setPasswordIcon(!showing);
    });

    setPasswordIcon(false);

    clearAll.addEventListener('click', () => {
      convertedItems = [];
      rows = [];
      resultsList.innerHTML = '';
      batchRows.innerHTML = '';
      batchOutput.innerHTML = '';
      convertStatus.textContent = '';
      hide(results);
      hide(batchSection);
      hide(rowsWarning);
      batchStatus.textContent = '';
      dryRun.checked = true;
      pushBatchBtn.textContent = 'Test configuration for all';
      hostInput.value = '';
      usernameInput.value = '';
      passwordInput.value = '';
      passwordInput.type = 'password';
      setPasswordIcon(false);
    });

    // --- Sites/Devices ---
    async function fetchSites(){
      try {
        const res = await fetch('/api/sites');
        const data = await res.json();
        if (!data.ok) throw new Error(JSON.stringify(data.error));
        sitesCache = data.items || [];
      } catch (e){
        sitesCache = [];
        console.error('Failed to fetch sites', e);
      }
    }
    async function fetchDevices(site_id){
      if (!site_id) return [];
      if (devicesBySite.has(site_id)) return devicesBySite.get(site_id);
      try {
        const url = new URL('/api/site_devices', window.location.origin);
        url.searchParams.set('site_id', site_id);
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) throw new Error(JSON.stringify(data.error));
        devicesBySite.set(site_id, data.items || []);
        return data.items || [];
      } catch (e){
        console.error('Failed to fetch devices', e);
        devicesBySite.set(site_id, []);
        return [];
      }
    }

    // --- Conversion ---
    function parseHosts(raw){
      if (!raw) return [];
      const tokens = raw.split(/[\n,]+/).map(h => h.trim()).filter(Boolean);
      return Array.from(new Set(tokens));
    }

    collectBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const hosts = parseHosts(hostInput.value || '');
      if (!hosts.length){
        convertStatus.textContent = 'Enter at least one hostname or IP address.';
        return;
      }

      const username = (usernameInput.value || '').trim();
      const password = passwordInput.value || '';
      if (!username || !password){
        convertStatus.textContent = 'Enter SSH credentials to collect configurations.';
        return;
      }

      collectBtn.disabled = true;
      collectBtn.textContent = 'Collecting…';
      convertStatus.textContent = 'Collecting configurations…';

      try {
        const res = await fetch('/api/convert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            hosts,
            username,
            password,
            strict_overflow: strictOverflow.checked
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok){
          const baseErr = data.error || `Request failed (${res.status})`;
          const extraErr = (data.errors && data.errors.length)
            ? ': ' + data.errors.map(e => `${e.host}: ${e.error}`).join('; ')
            : '';
          convertStatus.textContent = `Error: ${baseErr}${extraErr}`;
          return;
        }

        const successes = data.items || [];
        if (!sitesCache.length) await fetchSites();

        const existingIndex = new Map();
        convertedItems.forEach((item, idx) => {
          if (item?.source_file) existingIndex.set(item.source_file, idx);
        });

        const newRowIndices = [];
        successes.forEach((item, i) => {
          const label = item?.source_file || item?.host || '';
          const sourceLabel = label || `device-${convertedItems.length + newRowIndices.length + 1}`;
          item.source_file = sourceLabel;
          const existing = existingIndex.get(sourceLabel);
          if (existing !== undefined){
            convertedItems[existing] = item;
          } else {
            const newIdx = convertedItems.length;
            convertedItems.push(item);
            existingIndex.set(sourceLabel, newIdx);
            newRowIndices.push(newIdx);
          }
        });

        const defaultSite = rows.length ? rows[0].site_id : (sitesCache[0]?.id || '');
        for (const idx of newRowIndices){
          rows.push({
            idx,
            site_id: defaultSite || '',
            device_id: '',
            excludes: '',
            exclude_uplinks: true,
            member_offset: 0,
            port_offset: 0,
            model_override: '',
            userChangedSite: false
          });
        }
        if (defaultSite && newRowIndices.length) await fetchDevices(defaultSite);

        if (convertedItems.length){
          renderConvertedList();
          renderBatchRows();
          show(batchSection);
        }

        const parts = [];
        if (successes.length){
          parts.push(`Converted ${successes.length} device(s). Total: ${convertedItems.length}.`);
        }
        if (data.errors?.length){
          const summary = data.errors.map(e => `${e.host}: ${e.error}`).join('; ');
          parts.push(`Failed: ${summary}`);
        }
        convertStatus.textContent = parts.join(' ') || 'No configurations collected.';
      } catch (err){
        convertStatus.textContent = `Error: ${err?.message || err}`;
      } finally {
        collectBtn.disabled = false;
        collectBtn.textContent = 'Collect configs';
        passwordInput.value = '';
      }
    });

    function renderConvertedList(){
      show(results);
      resultsList.innerHTML = '';
      convertedItems.forEach((it, idx) => {
        const card = document.createElement('div');
        card.className = 'rounded-xl border bg-white dark:bg-slate-800 dark:border-slate-700 p-4';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${escapeHtml(it.source_file)}</div>
            <div class="text-xs text-slate-500 dark:text-slate-300">Row ${idx+1}</div>
          </div>
          <details class="mt-2">
            <summary class="cursor-pointer text-sm text-slate-600 dark:text-slate-300">Preview JSON</summary>
            <pre class="text-xs mt-2 p-2 bg-slate-50 dark:bg-slate-900/60 border dark:border-slate-700 rounded overflow-auto max-h-80">${escapeHtml(JSON.stringify(it.json, null, 2))}</pre>
          </details>
        `;
        resultsList.appendChild(card);
      });
    }

    // --- Batch rows UI ---
    function siteOptionsHtml(selectedId){
      const opts = ['<option value="">Select a site…</option>'];
      sitesCache.forEach(s => {
        const sel = (s.id === selectedId) ? 'selected' : '';
        const shortId = s.id ? s.id.slice(0,8) : '';
        opts.push(`<option value="${s.id}" ${sel}>${escapeHtml(s.name)}${shortId ? ' ('+shortId+')' : ''}</option>`);
      });
      return opts.join('');
    }
    function deviceOptionsHtml(site_id, selectedId){
      const devs = devicesBySite.get(site_id) || [];
      const opts = ['<option value="">Select a device…</option>'];
      devs.forEach(d => {
        const label = `${d.name} — ${d.model || ''} ${d.type ? `(${d.type})` : ''}`.trim();
        const sel = (d.id === selectedId) ? 'selected' : '';
        opts.push(`<option value="${d.id}" ${sel}>${escapeHtml(label)}</option>`);
      });
      return opts.join('');
    }

    function renderBatchRows(){
      batchRows.innerHTML = '';
      rows.forEach((row, i) => {
        const dup = isPairDuplicate(row.device_id, row.member_offset, row.port_offset);
        const dupClass = dup ? 'ring-2 ring-rose-500' : '';
        const el = document.createElement('div');
        el.className = 'p-4';
        el.innerHTML = `
          <div class="grid md:grid-cols-12 gap-2 items-end">
            <div class="md:col-span-1">
              <label class="block text-xs font-medium mb-1">File</label>
              <div class="text-sm text-slate-700 dark:text-slate-200 truncate" title="${escapeHtml(convertedItems[row.idx]?.source_file || '')}">
                ${escapeHtml(convertedItems[row.idx]?.source_file || '(missing)')}
              </div>
            </div>

            <div class="md:col-span-3">
              <label class="block text-xs font-medium mb-1">Site</label>
              <select data-rowsel="site" data-row="${i}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700">${siteOptionsHtml(row.site_id)}</select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-medium mb-1">Device</label>
              <select data-rowsel="device" data-row="${i}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700 ${dupClass}">
                ${row.site_id ? deviceOptionsHtml(row.site_id, row.device_id) : '<option value="">Select a site first</option>'}
              </select>
            </div>

          <div class="md:col-span-1">
              <label class="block text-xs font-medium mb-1 tooltip">
                <span class="inline-flex items-center gap-1">Start member
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
                </span>
                <span class="tip">Offset Cisco member numbering when mapping to a Juniper VC. Example: two 48-port Cisco stacks become a single 5-member VC—set rows destined for members 0,1,2,3,4 accordingly.</span>
              </label>
              <input data-rowsel="offset" data-row="${i}" type="number" min="0" step="1" value="${row.member_offset}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700 ${dupClass}" />
            </div>

            <div class="md:col-span-1">
              <label class="block text-xs font-medium mb-1 tooltip">
                <span class="inline-flex items-center gap-1">Start port
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
                </span>
                <span class="tip">Shift port numbering within a member. Example: two 24-port switches forming one 48-port device—set the second row to Start port 24 so its ports map to 24–47.</span>
              </label>
              <input data-rowsel="port" data-row="${i}" type="number" min="0" step="1" value="${row.port_offset}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700 ${dupClass}" />
            </div>

            <div class="md:col-span-3">
              <label class="block text-xs font-medium mb-1 tooltip">
                <span class="inline-flex items-center gap-1">Exclude interfaces
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zM9 9h2v6H9V9zm0-4h2v2H9V5z"/></svg>
                </span>
                <span class="tip">Skip specific interfaces from being pushed (e.g., uplinks or special ports). Use full Juniper names, comma-separated. Ranges like <code>xe-0/2/[0-3]</code> are supported.</span>
              </label>
              <div class="flex items-center gap-2 mb-1">
                <input data-rowsel="exclude_uplinks" data-row="${i}" type="checkbox" class="w-4 h-4" ${row.exclude_uplinks ? 'checked' : ''} />
                <span class="text-sm">Exclude uplinks</span>
              </div>
              <input data-rowsel="excludes" data-row="${i}" type="text" placeholder="ge-0/2/0, xe-0/2/1" value="${escapeHtml(row.excludes)}" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" />
            </div>

            <div class="md:col-span-1 flex items-end justify-end">
              <button class="h-9 w-9 flex items-center justify-center rounded border border-rose-500 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/30" title="Remove row" data-rowremove="${i}">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 8.586l3.536-3.536 1.414 1.414L11.414 10l3.536 3.536-1.414 1.414L10 11.414l-3.536 3.536-1.414-1.414L8.586 10 5.05 6.464l1.414-1.414L10 8.586z" clip-rule="evenodd"/></svg>
              </button>
            </div>
          </div>
        `;
        batchRows.appendChild(el);
      });

      // listeners
      batchRows.querySelectorAll('select[data-rowsel="site"]').forEach(sel => {
        sel.addEventListener('change', async () => {
          const i = parseInt(sel.getAttribute('data-row'));
          const oldFirst = rows[0]?.site_id || '';
          rows[i].site_id = sel.value;
          rows[i].device_id = '';
          rows[i].userChangedSite = true;

          if (rows[i].site_id) await fetchDevices(rows[i].site_id);
          updateDeviceSelect(i);
          updatePairDuplicateWarning();

          // Propagate from first row to others (only rows not manually changed)
          if (i === 0 && sel.value !== oldFirst) {
            await propagateFirstSite(rows[0].site_id);
          }
        });
      });
      batchRows.querySelectorAll('select[data-rowsel="device"]').forEach(sel => {
        sel.addEventListener('change', () => {
          const i = parseInt(sel.getAttribute('data-row'));
          rows[i].device_id = sel.value;
          updatePairDuplicateWarning();
          markPairDuplicateClass(i);
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="offset"]').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          const v = parseInt(inp.value || '0'); rows[i].member_offset = isNaN(v) ? 0 : Math.max(0, v);
          updatePairDuplicateWarning();
          markPairDuplicateClass(i);
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="port"]').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          const v = parseInt(inp.value || '0'); rows[i].port_offset = isNaN(v) ? 0 : Math.max(0, v);
          updatePairDuplicateWarning();
          markPairDuplicateClass(i);
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="excludes"]').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          rows[i].excludes = inp.value || '';
        });
      });
      batchRows.querySelectorAll('input[data-rowsel="exclude_uplinks"]').forEach(inp => {
        inp.addEventListener('change', () => {
          const i = parseInt(inp.getAttribute('data-row'));
          rows[i].exclude_uplinks = inp.checked;
        });
      });
      batchRows.querySelectorAll('button[data-rowremove]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.getAttribute('data-rowremove'));
          rows.splice(i, 1);
          renderBatchRows();
          updatePairDuplicateWarning();
        });
      });

      updatePairDuplicateWarning();
    }

    // Propagate first row's Site to rows that were NOT manually changed
    async function propagateFirstSite(newSiteId){
      if (!newSiteId) return;
      await fetchDevices(newSiteId); // prime cache
      for (let j = 1; j < rows.length; j++){
        if (!rows[j].userChangedSite) {
          rows[j].site_id = newSiteId;
          rows[j].device_id = '';
          updateSiteSelect(j);
          updateDeviceSelect(j);
        }
      }
    }

    function updateSiteSelect(i){
      const row = rows[i];
      const sel = batchRows.querySelector(`select[data-rowsel="site"][data-row="${i}"]`);
      if (!sel) return;
      sel.innerHTML = siteOptionsHtml(row.site_id);
    }
    function updateDeviceSelect(i){
      const row = rows[i];
      const sel = batchRows.querySelector(`select[data-rowsel="device"][data-row="${i}"]`);
      if (!sel) return;
      if (!row.site_id) { sel.innerHTML = '<option value="">Select a site first</option>'; return; }
      sel.innerHTML = deviceOptionsHtml(row.site_id, row.device_id);
      markPairDuplicateClass(i);
    }

    // Duplicate logic: allow same device multiple times if Start member/Start port differ
    function isPairDuplicate(device_id, member_offset, port_offset){
      if (!device_id) return false;
      const key = `${device_id}@@${member_offset}@@${port_offset}`;
      let seen = 0;
      for (const r of rows){
        if (r.device_id && `${r.device_id}@@${r.member_offset}@@${r.port_offset}` === key) {
          seen += 1;
          if (seen > 1) return true;
        }
      }
      return false;
    }
    function updatePairDuplicateWarning(){
      let hasDup = false;
      const counter = new Map();
      for (const r of rows){
        if (!r.device_id) continue;
        const key = `${r.device_id}@@${r.member_offset}@@${r.port_offset}`;
        counter.set(key, (counter.get(key) || 0) + 1);
      }
      for (const count of counter.values()){
        if (count > 1) { hasDup = true; break; }
      }
      if (hasDup){
        rowsWarning.innerHTML = 'Duplicate device with the same <em>Start member</em> and <em>Start port</em> detected. Use different offsets for repeated device selections.';
        show(rowsWarning);
        pushBatchBtn.disabled = true;
        pushBatchBtn.classList.add('cursor-not-allowed','opacity-70');
      } else {
        hide(rowsWarning);
        pushBatchBtn.disabled = false;
        pushBatchBtn.classList.remove('cursor-not-allowed','opacity-70');
      }
      rows.forEach((_, i) => markPairDuplicateClass(i));
    }
    function markPairDuplicateClass(i){
      const row = rows[i];
      const devSel = batchRows.querySelector(`select[data-rowsel="device"][data-row="${i}"]`);
      const offInp = batchRows.querySelector(`input[data-rowsel="offset"][data-row="${i}"]`);
      const portInp = batchRows.querySelector(`input[data-rowsel="port"][data-row="${i}"]`);
      const dup = isPairDuplicate(row.device_id, row.member_offset, row.port_offset);
      [devSel, offInp, portInp].forEach(el => {
        if (!el) return;
        el.classList.toggle('ring-2', dup);
        el.classList.toggle('ring-rose-500', dup);
      });
    }

    // --- Batch push ---
    function syncPushBtnLabel(){ pushBatchBtn.textContent = dryRun.checked ? 'Test configuration for all' : 'Push configuration for all'; }
    dryRun.addEventListener('change', syncPushBtnLabel);
    syncPushBtnLabel();

    pushBatchBtn.addEventListener('click', async () => {
      batchOutput.innerHTML = '';
      batchStatus.textContent = '';

      for (const r of rows){
        if (!r.site_id || !r.device_id){
          alert('Each row must have a Site and a Device selected.');
          return;
        }
      }
      if (pushBatchBtn.disabled) return;

      const payloadRows = rows.map(r => ({
        site_id: r.site_id,
        device_id: r.device_id,
        input_json: convertedItems[r.idx].json,
        excludes: r.excludes,
        exclude_uplinks: r.exclude_uplinks,
        member_offset: r.member_offset,
        port_offset: r.port_offset,
        model_override: r.model_override || ''
      }));

      const form = new FormData();
      form.append('rows', JSON.stringify(payloadRows));
      form.append('dry_run', dryRun.checked ? 'true' : 'false');
      form.append('tz', tz.value.trim());
      const mo = (modelOverride.value || '').trim();
      if (mo) form.append('model_override', mo);

      pushBatchBtn.disabled = true;
      pushBatchBtn.textContent = dryRun.checked ? 'Testing…' : 'Applying…';

      try {
        const res = await fetch('/api/push_batch', { method: 'POST', body: form });
        const data = await res.json();

        const okCount = (data.results || []).filter(r => r.ok).length;
        const total = (data.results || []).length;
        batchStatus.textContent = `${okCount}/${total} ${dryRun.checked ? 'tests' : 'pushes'} succeeded.`;

        renderBatchResults(data.results || []);

      } catch (e){
        batchOutput.innerHTML = `
          <div class="rounded-lg border p-3 status-error dark:bg-rose-950">
            <div class="font-medium">Unexpected error</div>
            <div class="text-sm mt-1">${escapeHtml(String(e))}</div>
          </div>`;
      } finally {
        pushBatchBtn.disabled = false;
        syncPushBtnLabel();
      }
    });

    function renderBatchResults(results){
      batchOutput.innerHTML = '';
      results.forEach((r, i) => {
        const fileLabel = convertedItems[rows[r.row_index]?.idx || 0]?.source_file || `Row ${i+1}`;
        const statusBadge = r.ok
          ? '<span class="inline-block px-2 py-0.5 text-xs rounded bg-emerald-100 text-emerald-800">OK</span>'
          : '<span class="inline-block px-2 py-0.5 text-xs rounded bg-rose-100 text-rose-800">Failed</span>';

        const warnings = (r.validation && Array.isArray(r.validation.warnings)) ? r.validation.warnings : [];
        const errors   = (r.validation && Array.isArray(r.validation.errors))   ? r.validation.errors   : [];
        let metaHtml = '';
        if (warnings.length || errors.length) {
          const items = []
            .concat(errors.map(e => `<li class="text-rose-700">• ${escapeHtml(String(e))}</li>`))
            .concat(warnings.map(w => `<li class="text-amber-700">• ${escapeHtml(String(w))}</li>`))
            .join('');
          metaHtml = `
            <div class="rounded-lg border p-3 mb-3 ${errors.length ? 'status-error dark:bg-rose-950' : 'status-info dark:bg-slate-800/60'}">
              <div class="font-medium">${errors.length ? 'Issues detected' : 'Warnings'}</div>
              <ul class="mt-1 text-sm">${items}</ul>
            </div>
          `;
        }

        const payloadStr = escapeHtml(JSON.stringify(r.payload || {}, null, 2));
        const mistResp = (!r.dry_run && r.response) ? `
          <details class="mt-3">
            <summary class="cursor-pointer text-sm text-slate-600 dark:text-slate-300">Mist API response</summary>
            <pre class="text-xs mt-2 p-2 bg-white dark:bg-slate-900/60 border dark:border-slate-700 rounded overflow-auto max-h-96">${escapeHtml(JSON.stringify(r.response, null, 2))}</pre>
          </details>` : '';

        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl border p-4';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${escapeHtml(fileLabel)}</div>
            <div class="text-xs text-slate-600 dark:text-slate-300 flex items-center gap-2">
              <span>Site: ${escapeHtml(r.site_id || '')}</span>
              <span>Device: ${escapeHtml(r.device_id || '')}</span>
              ${statusBadge}
            </div>
          </div>
          ${metaHtml}
          <div class="rounded-lg border dark:border-slate-700 p-3 bg-white dark:bg-slate-800">
            <div class="text-sm font-medium mb-2">Payload to Mist</div>
            <pre class="text-xs p-2 bg-slate-50 dark:bg-slate-900/60 border dark:border-slate-700 rounded overflow-auto max-h-96">${payloadStr}</pre>
          </div>
          ${mistResp}
        `;
        batchOutput.appendChild(card);
      });
    }

    // --- Init ---
    window.addEventListener('load', async () => {
      await fetchSites();
      dryRun.checked = true;
      pushBatchBtn.textContent = 'Test configuration for all';
    });
  </script>
</body>
</html>
