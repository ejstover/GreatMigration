<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{DOC_TITLE}}</title>
  <link rel="icon" type="image/png" href="/static/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'media' };</script>
  <style>
  </style>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 overflow-x-hidden">
    <nav id="menu" class="fixed inset-y-0 left-0 w-64 bg-white text-slate-900 dark:bg-slate-800 dark:text-slate-100 transform -translate-x-full transition-transform duration-300 z-50 shadow-lg p-4 space-y-2">
      <p id="user_greeting" class="hidden px-4 py-2 font-semibold"></p>
      <a href="/hardware" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_HARDWARE}}</a>
      <a href="/replacements" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_REPLACEMENTS}}</a>
      <a href="/" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_CONFIG}}</a>
      <a href="/rules" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_RULES}}</a>
      <a href="{{HELP_URL}}" target="_blank" rel="noopener" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Help</a>
      <button id="logout_btn" class="hidden w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Log out</button>
    </nav>
    <div id="main" class="transition-all duration-300">
    <header class="mb-6 bg-gradient-to-r from-emerald-500 to-sky-500 text-white shadow-lg">
      <div class="max-w-7xl mx-auto flex items-center gap-4 p-6">
        <button id="menu_btn" class="p-2 rounded hover:bg-white/30" aria-label="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex items-center gap-4">
          <img src="/static/logo.png" alt="Logo" class="h-16 w-16" />
          <div>
            <h1 class="text-3xl font-bold">{{BANNER_TITLE}}</h1>
            <p class="text-slate-100 text-sm md:text-base">{{BANNER_TAGLINE}}</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-5xl mx-auto p-6">
    <section class="mb-6">
      <div class="rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 shadow p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1" for="ssh_targets">Device hostnames or IPs</label>
          <textarea id="ssh_targets" class="w-full border rounded p-2 h-28 dark:bg-slate-900 dark:border-slate-700" placeholder="switch1.example.com&#10;10.0.0.5" spellcheck="false"></textarea>
          <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Enter one host per line. The command runs on each device using the provided credentials.</p>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="ssh_username">Username</label>
            <input id="ssh_username" type="text" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" autocomplete="username" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="ssh_password">Password</label>
            <div class="relative">
              <input id="ssh_password" type="password" class="w-full border rounded p-2 pr-20 dark:bg-slate-900 dark:border-slate-700" autocomplete="current-password" />
              <button id="toggle_password" type="button" class="absolute inset-y-0 right-0 px-3 text-xs font-medium text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300">Show</button>
            </div>
          </div>
        </div>
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div id="upload_status" class="text-sm text-slate-600 dark:text-slate-300"></div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="run_fetch" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Collect hardware data</button>
            <button id="clear_all" class="px-4 py-2 rounded bg-rose-600 text-white hover:bg-rose-700 dark:bg-rose-700 dark:hover:bg-rose-600">Clear</button>
            <button id="export_pdf" class="hidden px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">Download PDF</button>
          </div>
        </div>
        <ul id="host_status_list" class="space-y-2 text-sm"></ul>
      </div>
    </section>

    <section id="results" class="hidden space-y-4"></section>
    </div>
    </div>

    <script>
      const menuBtn = document.getElementById('menu_btn');
      const menu = document.getElementById('menu');
      const main = document.getElementById('main');
      menuBtn.addEventListener('click', () => {
        menu.classList.toggle('-translate-x-full');
        main.classList.toggle('ml-64');
      });
      document.addEventListener('click', e => {
        if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
          menu.classList.add('-translate-x-full');
          main.classList.remove('ml-64');
        }
      });

    const userGreeting = document.getElementById('user_greeting');
    const logoutBtn = document.getElementById('logout_btn');
    fetch('/me').then(res => { if (!res.ok) throw new Error('not authed'); return res.json(); }).then(data => {
      userGreeting.textContent = `Hey ${data.user.name}!`;
      userGreeting.classList.remove('hidden');
      logoutBtn?.classList.remove('hidden');
      logoutBtn?.addEventListener('click', (e) => { e.preventDefault(); window.location.href = '/logout'; });
    }).catch(() => { window.location.href = '/login'; });

    const uploadStatus = document.getElementById('upload_status');
    const results = document.getElementById('results');
    const exportBtn = document.getElementById('export_pdf');
    const clearBtn = document.getElementById('clear_all');
    const fetchBtn = document.getElementById('run_fetch');
    const hostInput = document.getElementById('ssh_targets');
    const usernameInput = document.getElementById('ssh_username');
    const passwordInput = document.getElementById('ssh_password');
    const statusList = document.getElementById('host_status_list');
    const passwordToggle = document.getElementById('toggle_password');

    let lastResults = [];

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
    }

    passwordToggle?.addEventListener('click', () => {
      if (!passwordInput) return;
      const hidden = passwordInput.type === 'password';
      passwordInput.type = hidden ? 'text' : 'password';
      passwordToggle.textContent = hidden ? 'Hide' : 'Show';
    });

    fetchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      collectHardware();
    });

    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      results.innerHTML = '';
      results.classList.add('hidden');
      uploadStatus.textContent = '';
      exportBtn.classList.add('hidden');
      statusList.innerHTML = '';
      lastResults = [];
    });

    function renderHostStatuses(hosts){
      statusList.innerHTML = '';
      hosts.forEach(host => {
        const li = document.createElement('li');
        li.dataset.host = host;
        li.className = 'flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/60 px-3 py-2';
        li.innerHTML = `<span data-role="host" class="font-medium">${escapeHtml(host)}</span><span data-role="status" class="text-slate-500">Pending…</span>`;
        statusList.appendChild(li);
      });
    }

    function updateHostStatuses(items){
      if (!Array.isArray(items)) return;
      items.forEach(item => {
        if (!item) return;
        const hostKey = item.host || '';
        if (!hostKey) return;
        const li = Array.from(statusList.children).find(el => el.dataset.host === hostKey);
        if (!li) return;
        const hostLabel = li.querySelector('[data-role="host"]');
        const statusEl = li.querySelector('[data-role="status"]');
        if (!statusEl) return;
        if (hostLabel){
          const label = item.filename || (item.hostname ? `${item.host} → ${item.hostname}` : item.host || '');
          if (label) hostLabel.textContent = label;
        }
        if (item.ok){
          statusEl.textContent = item.message || 'Success';
          statusEl.className = 'text-emerald-600 dark:text-emerald-400 font-medium';
          li.classList.add('bg-emerald-50', 'dark:bg-emerald-900/40', 'border-emerald-200');
          li.classList.remove('bg-slate-50', 'dark:bg-slate-900/60', 'border-slate-200');
        } else {
          statusEl.textContent = item.error || 'Failed';
          statusEl.className = 'text-rose-600 dark:text-rose-300 font-medium';
          li.classList.add('bg-rose-50', 'dark:bg-rose-900/40', 'border-rose-200');
          li.classList.remove('bg-slate-50', 'dark:bg-slate-900/60', 'border-slate-200');
        }
      });
    }

    async function collectHardware(){
      const hosts = (hostInput.value || '').split(/\r?\n/).map(h => h.trim()).filter(Boolean);
      if (!hosts.length){
        uploadStatus.textContent = 'Enter at least one host.';
        return;
      }
      if (!usernameInput.value.trim()){
        uploadStatus.textContent = 'Username is required.';
        return;
      }
      if (!passwordInput.value){
        uploadStatus.textContent = 'Password is required.';
        return;
      }

      const uniqueHosts = Array.from(new Map(hosts.map(h => [h, h])).values());
      renderHostStatuses(uniqueHosts);
      uploadStatus.textContent = `Collecting data from ${uniqueHosts.length} device${uniqueHosts.length === 1 ? '' : 's'}...`;

      try {
        const res = await fetch('/api/showtech', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            hosts: uniqueHosts,
            username: usernameInput.value.trim(),
            password: passwordInput.value,
          }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok){
          throw new Error(data?.error || `Request failed with status ${res.status}`);
        }

        updateHostStatuses(data.results);
        const successes = (data.results || []).filter(r => r && r.ok);
        const failed = data.summary?.failed ?? ((data.results?.length || 0) - successes.length);
        lastResults = successes;
        renderResults(successes);

        if (successes.length){
          uploadStatus.textContent = `Completed: ${successes.length} succeeded, ${failed} failed.`;
          exportBtn.classList.remove('hidden');
        } else {
          uploadStatus.textContent = `No hardware data collected. ${failed} failed.`;
          exportBtn.classList.add('hidden');
        }
      } catch (err){
        uploadStatus.textContent = 'Error: ' + (err.message || err);
        exportBtn.classList.add('hidden');
      }
    }

    function renderResults(items){
      results.innerHTML='';
      if(!items?.length){ results.classList.add('hidden'); return; }
      results.classList.remove('hidden');
      items.forEach(file => {
        const wrap = document.createElement('div');
        wrap.className = 'bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-4';
        const h = document.createElement('h3');
        h.className = 'font-medium mb-2';
        h.textContent = file.filename || file.host || 'Device';
        wrap.appendChild(h);
        file.switches.forEach(sw => {
          const s = document.createElement('div');
          s.className = 'mb-2';
          const sh = document.createElement('h4');
          sh.className = 'font-semibold';
          sh.textContent = sw.switch;
          s.appendChild(sh);
          const ul = document.createElement('ul');
          sw.items.forEach(it => {
            const li = document.createElement('li');
            li.textContent = `${it.pid} x${it.count} -> ${it.replacement}`;
            ul.appendChild(li);
          });
          s.appendChild(ul);
          wrap.appendChild(s);
        });
        if(file.copper_10g_ports?.total){
          const p = document.createElement('p');
          p.className = 'mt-2 font-semibold';
          p.textContent = `10Gb copper ports requiring SFPs (SFPP-10G-T): ${file.copper_10g_ports.total}`;
          wrap.appendChild(p);
        }
        results.appendChild(wrap);
      });
    }

    exportBtn.addEventListener('click', () => {
      if(!lastResults?.length) return;
      fetch('/api/showtech/pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ results: lastResults })
      })
        .then(res => res.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'hardware_conversion_report.pdf';
          document.body.appendChild(a); a.click(); a.remove();
          window.URL.revokeObjectURL(url);
        });
    });
  </script>
</body>
</html>
