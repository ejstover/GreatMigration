<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{DOC_TITLE}}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'media' };</script>
  <style>
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color: #60a5fa; background: #f8fafc; }
  </style>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 overflow-x-hidden">
    <nav id="menu" class="fixed inset-y-0 left-0 w-64 bg-white text-slate-900 dark:bg-slate-800 dark:text-slate-100 transform -translate-x-full transition-transform duration-300 z-50 shadow-lg p-4 space-y-2">
      <p id="user_greeting" class="hidden px-4 py-2 font-semibold"></p>
      <a href="/hardware" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_HARDWARE}}</a>
      <a href="/replacements" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_REPLACEMENTS}}</a>
      <a href="/" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_CONFIG}}</a>
      <a href="/rules" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_RULES}}</a>
      <a href="{{HELP_URL}}" target="_blank" rel="noopener" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Help</a>
      <button id="logout_btn" class="hidden w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Log out</button>
    </nav>
    <div id="main" class="transition-all duration-300">
    <header class="mb-6 bg-gradient-to-r from-emerald-500 to-sky-500 text-white shadow-lg">
      <div class="max-w-7xl mx-auto flex items-center gap-4 p-6">
        <button id="menu_btn" class="p-2 rounded hover:bg-white/30" aria-label="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex items-center gap-4">
          <img src="/static/logo.png" alt="Logo" class="h-16 w-16" />
          <div>
            <h1 class="text-3xl font-bold">{{BANNER_TITLE}}</h1>
            <p class="text-slate-100 text-sm md:text-base">{{BANNER_TAGLINE}}</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-5xl mx-auto p-6">
    <section class="mb-6">
      <div class="rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 p-6 shadow space-y-4">
        <div>
          <h2 class="text-lg font-medium">Collect Inventory from switches</h2>
          <p class="text-sm text-slate-600 dark:text-slate-300 mt-1">Provide one hostname or IP per line. Credentials are requested for each collection and are not stored.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="host_list">Switch hostnames or IPs</label>
          <textarea id="host_list" class="w-full border rounded-lg p-3 h-32 resize-y dark:bg-slate-900 dark:border-slate-700" placeholder="switch1.example.com&#10;10.0.0.2"></textarea>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="ssh_username">SSH username</label>
            <input id="ssh_username" type="text" class="w-full border rounded p-2 dark:bg-slate-900 dark:border-slate-700" autocomplete="username" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="ssh_password">SSH password</label>
            <div class="relative">
              <input id="ssh_password" type="password" class="w-full border rounded p-2 pr-10 dark:bg-slate-900 dark:border-slate-700" autocomplete="current-password" />
              <button type="button" id="toggle_password" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" aria-label="Toggle password visibility">
                <svg id="toggle_password_icon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c1.5-4 5.25-6.75 9.75-6.75S20.25 8 21.75 12c-1.5 4-5.25 6.75-9.75 6.75S3.75 16 2.25 12z" />
                  <circle cx="12" cy="12" r="2.25" />
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="flex items-center justify-between flex-col md:flex-row gap-3">
          <div id="upload_status" class="flex-1 text-sm text-slate-600 dark:text-slate-300"></div>
          <div class="flex items-center gap-2">
            <button id="collect_hosts" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Collect Inventory</button>
            <button id="clear_all" class="px-4 py-2 rounded bg-rose-600 text-white hover:bg-rose-700">Clear</button>
            <button id="export_pdf" class="hidden px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">Download PDF</button>
          </div>
        </div>
      </div>
    </section>

    <section id="results" class="hidden space-y-4"></section>
    </div>
    </div>

    <script>
      const menuBtn = document.getElementById('menu_btn');
      const menu = document.getElementById('menu');
      const main = document.getElementById('main');
      menuBtn.addEventListener('click', () => {
        menu.classList.toggle('-translate-x-full');
        main.classList.toggle('ml-64');
      });
      document.addEventListener('click', e => {
        if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
          menu.classList.add('-translate-x-full');
          main.classList.remove('ml-64');
        }
      });

    const userGreeting = document.getElementById('user_greeting');
    const logoutBtn = document.getElementById('logout_btn');
    fetch('/me').then(res => { if (!res.ok) throw new Error('not authed'); return res.json(); }).then(data => {
      userGreeting.textContent = `Hey ${data.user.name}!`;
      userGreeting.classList.remove('hidden');
      logoutBtn?.classList.remove('hidden');
      logoutBtn?.addEventListener('click', (e) => { e.preventDefault(); window.location.href = '/logout'; });
    }).catch(() => { window.location.href = '/login'; });

    const hostInput = document.getElementById('host_list');
    const usernameInput = document.getElementById('ssh_username');
    const passwordInput = document.getElementById('ssh_password');
    const togglePassword = document.getElementById('toggle_password');
    const togglePasswordIcon = document.getElementById('toggle_password_icon');
    const collectBtn = document.getElementById('collect_hosts');
    const uploadStatus = document.getElementById('upload_status');
    const results = document.getElementById('results');
    const exportBtn = document.getElementById('export_pdf');
    const clearBtn = document.getElementById('clear_all');

    let lastResults = null;

    function escapeHtml(str){ return String(str).replace(/[&<>'"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[c])); }

    function createStatusTracker(container, hosts, options = {}){
      if (!container) return null;
      const stageLabels = options.stageLabels || ['Queued', 'Logging in…', 'Collecting inventory…', 'Processing inventory…'];
      const successLabel = options.successLabel || 'Complete';
      const entries = hosts.map(h => ({
        host: h,
        key: (h || '').toString().trim().toLowerCase(),
        stageIndex: 0,
        status: stageLabels[0],
        done: false,
        error: null,
      }));
      let summary = options.summary || '';
      let timer = null;
      let pointer = 0;

      function findEntry(identifier){
        const key = (identifier || '').toString().trim().toLowerCase();
        return entries.find(e => e.key === key)
          || entries.find(e => e.host.toLowerCase() === key)
          || (key ? entries.find(e => key.includes(e.key)) : undefined)
          || entries.find(e => !e.done);
      }

      function render(){
        if (!entries.length){
          container.textContent = summary || '';
          return;
        }
        const completed = entries.filter(e => e.done && !e.error).length;
        const failed = entries.filter(e => e.error).length;
        const total = entries.length;
        const progressed = completed + failed;
        const percent = total ? Math.round((progressed / total) * 100) : 0;
        const variant = failed ? 'error' : progressed === total ? 'success' : 'info';
        const color = variant === 'error' ? 'bg-rose-500' : variant === 'success' ? 'bg-emerald-500' : 'bg-sky-500';
        const labelColor = variant === 'error'
          ? 'text-rose-700 dark:text-rose-300'
          : variant === 'success'
            ? 'text-emerald-700 dark:text-emerald-300'
            : 'text-slate-600 dark:text-slate-300';
        const fillPercent = progressed ? Math.min(Math.max(percent, 8), 100) : 0;
        const items = entries.map(entry => {
          const state = entry.error ? `Error: ${entry.error}` : entry.status;
          const stateColor = entry.error
            ? 'text-rose-600 dark:text-rose-300'
            : entry.done
              ? 'text-emerald-600 dark:text-emerald-300'
              : 'text-slate-500 dark:text-slate-300';
          return `
            <li class="flex items-center justify-between gap-4 text-xs sm:text-sm">
              <span class="font-medium truncate" title="${escapeHtml(entry.host)}">${escapeHtml(entry.host)}</span>
              <span class="${stateColor} whitespace-nowrap">${escapeHtml(state)}</span>
            </li>
          `;
        }).join('');
        container.innerHTML = `
          <div class="space-y-2">
            <div class="flex items-center justify-between text-xs uppercase tracking-wide ${labelColor}">
              <span>${escapeHtml(summary || '')}</span>
              <span>${progressed}/${total}</span>
            </div>
            <div class="w-full bg-slate-200 dark:bg-slate-700/70 rounded-full h-2 overflow-hidden">
              <div class="${color} h-2 transition-all duration-300" style="width:${fillPercent}%"></div>
            </div>
            <ul class="space-y-1">${items}</ul>
          </div>
        `;
      }

      function advance(){
        const pending = entries.filter(e => !e.done && !e.error);
        if (!pending.length){
          api.stop();
          render();
          return;
        }
        const entry = pending[pointer % pending.length];
        pointer = (pointer + 1) % Math.max(pending.length, 1);
        if (entry.stageIndex < stageLabels.length - 1){
          entry.stageIndex += 1;
          entry.status = stageLabels[entry.stageIndex];
          render();
        }
      }

      timer = setInterval(advance, options.intervalMs || 1200);
      render();

      const api = {
        updateSummary(text){ summary = text; render(); },
        markSuccess(identifier, message){
          const entry = findEntry(identifier);
          if (!entry) return;
          entry.done = true;
          entry.error = null;
          entry.stageIndex = stageLabels.length;
          entry.status = message || successLabel;
          render();
        },
        markError(identifier, errorMessage){
          const entry = findEntry(identifier);
          if (!entry) return;
          entry.done = true;
          entry.error = errorMessage || 'Failed';
          entry.stageIndex = stageLabels.length;
          entry.status = 'Failed';
          render();
        },
        markAllError(errorMessage){
          const msg = errorMessage || 'Failed';
          entries.forEach(entry => {
            if (!entry.done){
              entry.done = true;
              entry.error = msg;
              entry.status = 'Failed';
              entry.stageIndex = stageLabels.length;
            }
          });
          summary = errorMessage || summary;
          render();
          api.stop();
        },
        stop(){
          if (timer){
            clearInterval(timer);
            timer = null;
          }
        },
        finalize(text){
          summary = text;
          api.stop();
          render();
        },
        hasEntries(){ return entries.length > 0; },
      };

      return api;
    }

    const eyeOpen = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c1.5-4 5.25-6.75 9.75-6.75S20.25 8 21.75 12c-1.5 4-5.25 6.75-9.75 6.75S3.75 16 2.25 12z"></path><circle cx="12" cy="12" r="2.25"></circle>';
    const eyeClosed = '<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.75 12c1.5 4 5.25 6.75 9.75 6.75 1.603 0 3.115-.332 4.48-.927M6.228 6.228A10.46 10.46 0 0112 5.25c4.5 0 8.25 2.75 9.75 6.75a10.523 10.523 0 01-2.03 3.173M6.228 6.228L3 3m3.228 3.228l11.544 11.544"></path><path stroke-linecap="round" stroke-linejoin="round" d="M9.88 9.88a2.25 2.25 0 003.182 3.182"></path>';

    function setPasswordIcon(isVisible){
      if (!togglePasswordIcon) return;
      togglePasswordIcon.innerHTML = isVisible ? eyeClosed : eyeOpen;
    }

    togglePassword?.addEventListener('click', () => {
      if (!passwordInput) return;
      const showing = passwordInput.type === 'text';
      passwordInput.type = showing ? 'password' : 'text';
      setPasswordIcon(!showing);
    });

    setPasswordIcon(false);

    let inventoryProgress = null;

    clearBtn.addEventListener('click', () => {
      inventoryProgress?.stop();
      inventoryProgress = null;
      results.innerHTML = '';
      results.classList.add('hidden');
      uploadStatus.innerHTML = '';
      exportBtn.classList.add('hidden');
      lastResults = null;
      hostInput.value = '';
      usernameInput.value = '';
      passwordInput.value = '';
      passwordInput.type = 'password';
      setPasswordIcon(false);
    });

    function parseHosts(raw){
      if (!raw) return [];
      const tokens = raw.split(/[\n,]+/).map(h => h.trim()).filter(Boolean);
      return Array.from(new Set(tokens));
    }

    collectBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const hosts = parseHosts(hostInput.value || '');
      if (!hosts.length){
        uploadStatus.textContent = 'Enter at least one hostname or IP address.';
        return;
      }

      const username = (usernameInput.value || '').trim();
      const password = passwordInput.value || '';
      if (!username || !password){
        uploadStatus.textContent = 'Enter SSH credentials to collect inventory.';
        return;
      }

      collectBtn.disabled = true;
      collectBtn.textContent = 'Collecting…';
      uploadStatus.innerHTML = '';
      inventoryProgress?.stop();
      inventoryProgress = createStatusTracker(uploadStatus, hosts, {
        summary: 'Collecting inventory…',
        stageLabels: ['Queued', 'Logging in…', 'Collecting inventory…', 'Processing inventory…'],
      });

      try {
        const res = await fetch('/api/showtech', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hosts, username, password })
        });
        const data = await res.json();
        if (!res.ok || !data.ok){
          const baseErr = data.error || `Request failed (${res.status})`;
          const extraErr = (data.errors && data.errors.length)
            ? ': ' + data.errors.map(e => `${e.host}: ${e.error}`).join('; ')
            : '';
          const message = `Error: ${baseErr}${extraErr}`;
          if (inventoryProgress?.hasEntries()){
            if (data.errors?.length){
              data.errors.forEach(e => inventoryProgress.markError(e.host || '', e.error || baseErr));
            } else {
              inventoryProgress.markAllError(message);
            }
            inventoryProgress.finalize(message);
            inventoryProgress = null;
          } else {
            uploadStatus.textContent = message;
          }
          results.innerHTML = '';
          results.classList.add('hidden');
          exportBtn.classList.add('hidden');
          lastResults = null;
          return;
        }

        const successes = data.results || [];
        lastResults = successes;
        if (successes.length){
          renderResults(successes);
          exportBtn.classList.remove('hidden');
        } else {
          results.innerHTML = '';
          results.classList.add('hidden');
          exportBtn.classList.add('hidden');
        }

        if (inventoryProgress?.hasEntries()){
          successes.forEach(item => {
            inventoryProgress.markSuccess(item?.filename || item?.host || '', 'Complete');
          });
          data.errors?.forEach(err => {
            inventoryProgress.markError(err.host || '', err.error || 'Failed');
          });
        }

        if (successes.length){
          results.classList.remove('hidden');
        }

        const parts = [];
        if (successes.length){
          parts.push(`Processed ${successes.length} device(s).`);
        } else {
          parts.push('No inventory collected.');
        }
        if (data.errors?.length){
          const summary = data.errors.map(e => `${e.host}: ${e.error}`).join('; ');
          parts.push(`Failed: ${summary}`);
        }
        const statusSummary = parts.join(' ');
        if (inventoryProgress?.hasEntries()){
          inventoryProgress.finalize(statusSummary);
          inventoryProgress = null;
        } else {
          uploadStatus.textContent = statusSummary;
        }
      } catch (err){
        const message = 'Error: ' + (err?.message || err);
        if (inventoryProgress?.hasEntries()){
          inventoryProgress.markAllError(message);
          inventoryProgress = null;
        } else {
          uploadStatus.textContent = message;
        }
        results.innerHTML = '';
        results.classList.add('hidden');
        exportBtn.classList.add('hidden');
        lastResults = null;
      } finally {
        collectBtn.disabled = false;
        collectBtn.textContent = 'Collect Inventory';
        passwordInput.value = '';
        passwordInput.type = 'password';
        setPasswordIcon(false);
        inventoryProgress?.stop();
      }
    });

    function renderResults(items){
      results.innerHTML='';
      if(!items?.length){ results.classList.add('hidden'); return; }
      results.classList.remove('hidden');
      items.forEach(file => {
        const wrap = document.createElement('div');
        wrap.className = 'bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-4';
        const h = document.createElement('h3');
        h.className = 'font-medium mb-2';
        h.textContent = file.filename;
        wrap.appendChild(h);
        file.switches.forEach(sw => {
          const s = document.createElement('div');
          s.className = 'mb-2';
          const sh = document.createElement('h4');
          sh.className = 'font-semibold';
          sh.textContent = sw.switch;
          s.appendChild(sh);
          const ul = document.createElement('ul');
          sw.items.forEach(it => {
            const li = document.createElement('li');
            li.textContent = `${it.pid} x${it.count} -> ${it.replacement}`;
            ul.appendChild(li);
          });
          s.appendChild(ul);
          wrap.appendChild(s);
        });
        if(file.copper_10g_ports?.total){
          const p = document.createElement('p');
          p.className = 'mt-2 font-semibold';
          p.textContent = `10Gb copper ports requiring SFPs (SFPP-10G-T): ${file.copper_10g_ports.total}`;
          wrap.appendChild(p);
        }
        results.appendChild(wrap);
      });
    }

    exportBtn.addEventListener('click', () => {
      if(!lastResults) return;
      fetch('/api/showtech/pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ results: lastResults })
      })
        .then(res => res.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'hardware_conversion_report.pdf';
          document.body.appendChild(a); a.click(); a.remove();
          window.URL.revokeObjectURL(url);
        });
    });
  </script>
</body>
</html>
