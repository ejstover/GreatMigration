<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{DOC_TITLE}}</title>
  <link rel="icon" type="image/png" href="/static/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'media' };</script>
  <style>
    .dropzone { border: 2px dashed #cbd5e1; }
    .dropzone.dragover { border-color: #60a5fa; background: #f8fafc; }
  </style>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 overflow-x-hidden">
    <nav id="menu" class="fixed inset-y-0 left-0 w-64 bg-white text-slate-900 dark:bg-slate-800 dark:text-slate-100 transform -translate-x-full transition-transform duration-300 z-50 shadow-lg p-4 space-y-2">
      <p id="user_greeting" class="hidden px-4 py-2 font-semibold"></p>
      <a href="/hardware" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_HARDWARE}}</a>
      <a href="/replacements" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_REPLACEMENTS}}</a>
      <a href="/" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_CONFIG}}</a>
      <a href="/rules" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_RULES}}</a>
      <a href="/audit" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_AUDIT}}</a>
      <a href="{{HELP_URL}}" target="_blank" rel="noopener" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Help</a>
      <button id="logout_btn" class="hidden w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Log out</button>
    </nav>
    <div id="main" class="transition-all duration-300">
    <header class="mb-6 bg-gradient-to-r from-emerald-500 to-sky-500 text-white shadow-lg">
      <div class="max-w-7xl mx-auto flex items-center gap-4 p-6">
        <button id="menu_btn" class="p-2 rounded hover:bg-white/30" aria-label="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex items-center gap-4">
          <img src="/static/logo.png" alt="Logo" class="h-16 w-16" />
          <div>
            <h1 class="text-3xl font-bold">{{BANNER_TITLE}}</h1>
            <p class="text-slate-100 text-sm md:text-base">{{BANNER_TAGLINE}}</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-5xl mx-auto p-6">
    <section class="mb-6">
      <div class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-6">
        <h2 class="text-lg font-medium mb-2">Collect hardware via SSH</h2>
        <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Provide the devices, SSH username, and password. Commands are executed individually to avoid long-running show tech dumps. Results appear below once all devices finish.</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label for="ssh_devices" class="block text-sm font-medium mb-1">Devices (one per line)</label>
            <textarea id="ssh_devices" class="w-full border rounded-lg p-3 min-h-[8rem] dark:bg-slate-900 dark:border-slate-700" placeholder="switch1.example.com&#10;10.0.0.5"></textarea>
          </div>
          <div class="space-y-4">
            <div>
              <label for="ssh_username" class="block text-sm font-medium mb-1">SSH username</label>
              <input id="ssh_username" type="text" class="w-full border rounded-lg p-3 dark:bg-slate-900 dark:border-slate-700" autocomplete="username" />
            </div>
            <div>
              <label for="ssh_password" class="block text-sm font-medium mb-1">SSH password</label>
              <div class="relative">
                <input id="ssh_password" type="password" class="w-full border rounded-lg p-3 pr-16 dark:bg-slate-900 dark:border-slate-700" autocomplete="current-password" />
                <button type="button" id="ssh_toggle_password" class="absolute inset-y-0 right-0 px-3 text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-200">Show</button>
              </div>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400">Usernames are remembered locally for convenience. Passwords are cleared immediately after each run.</p>
          </div>
        </div>
        <div class="flex items-center gap-3 mt-4">
          <button id="ssh_collect" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Collect hardware</button>
          <span id="ssh_progress" class="text-sm text-slate-600 dark:text-slate-300"></span>
        </div>
        <div id="ssh_failure_panel" class="hidden mt-4 rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700 dark:border-rose-900 dark:bg-rose-950/70 dark:text-rose-100">
          <div id="ssh_failure_summary" class="font-semibold"></div>
          <ul id="ssh_failure_list" class="mt-3 space-y-3"></ul>
        </div>
      </div>
    </section>

    <section class="mb-6">
      <div id="dz" class="dropzone rounded-2xl bg-white dark:bg-slate-800 dark:border-slate-700 p-8 text-center text-slate-500 dark:text-slate-300">
        <p class="mb-2">Drag & drop show tech files here (or click to select)</p>
        <input id="file_input" type="file" multiple class="hidden" accept=".txt" />
        <button id="choose_files" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Choose files</button>
      </div>
      <div class="flex items-center justify-between mt-2">
        <div id="upload_status" class="text-sm text-slate-600 dark:text-slate-300"></div>
        <div class="space-x-2">
          <button id="clear_all" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Clear</button>
          <button id="export_pdf" class="hidden px-4 py-2 rounded bg-sky-600 text-white hover:bg-sky-700">Download PDF</button>
        </div>
      </div>
    </section>

    <section class="mb-6">
      <div class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-6">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
          <div>
            <h2 class="text-lg font-medium">Accessories</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300">Add approved accessories to include them in the bill of materials export.</p>
          </div>
          <button id="add_accessory_btn" type="button" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
            <span class="text-lg leading-none">+</span>
            Add accessory
          </button>
        </div>
        <div id="accessories_list" class="space-y-3"></div>
        <p id="accessories_empty" class="mt-3 text-sm text-slate-600 dark:text-slate-300">Loading approved accessories…</p>
      </div>
    </section>

    <section id="bom_summary_section" class="hidden mb-6">
      <div class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-6">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-lg font-medium">Bill of Materials Summary</h2>
            <p class="text-sm text-slate-600 dark:text-slate-300">Combined count of recommended replacements and selected accessories.</p>
          </div>
        </div>
        <ul id="bom_summary_list" class="mt-4 space-y-2 text-sm"></ul>
        <p id="bom_summary_empty" class="mt-4 text-sm text-slate-600 dark:text-slate-300">Process hardware results or add accessories to build a bill of materials.</p>
      </div>
    </section>

    <section id="results" class="hidden space-y-4"></section>
    </div>
    </div>

    <div id="project_modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white dark:bg-slate-800 p-6 rounded shadow-lg w-80">
        <h3 class="text-lg font-medium mb-3">Project name</h3>
        <input id="project_modal_input" type="text" class="w-full border rounded p-2 mb-4 dark:bg-slate-900 dark:border-slate-700" placeholder="Optional project name" />
        <div class="flex justify-end gap-2">
          <button id="project_modal_cancel" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">Cancel</button>
          <button id="project_modal_ok" class="px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700">OK</button>
        </div>
      </div>
    </div>

    <script>
      const menuBtn = document.getElementById('menu_btn');
      const menu = document.getElementById('menu');
      const main = document.getElementById('main');
      menuBtn.addEventListener('click', () => {
        menu.classList.toggle('-translate-x-full');
        main.classList.toggle('ml-64');
      });
      document.addEventListener('click', e => {
        if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
          menu.classList.add('-translate-x-full');
          main.classList.remove('ml-64');
        }
      });

    const userGreeting = document.getElementById('user_greeting');
    const logoutBtn = document.getElementById('logout_btn');
    let currentUserName = null;
    fetch('/me').then(res => { if (!res.ok) throw new Error('not authed'); return res.json(); }).then(data => {
      currentUserName = data.user?.name || null;
      userGreeting.textContent = `Hey ${currentUserName || 'there'}!`;
      userGreeting.classList.remove('hidden');
      logoutBtn?.classList.remove('hidden');
      logoutBtn?.addEventListener('click', (e) => { e.preventDefault(); window.location.href = '/logout'; });
    }).catch(() => { window.location.href = '/login'; });

    const dz = document.getElementById('dz');
    const fileInput = document.getElementById('file_input');
    const chooseBtn = document.getElementById('choose_files');
    const uploadStatus = document.getElementById('upload_status');
    const results = document.getElementById('results');
    const bomSummarySection = document.getElementById('bom_summary_section');
    const bomSummaryList = document.getElementById('bom_summary_list');
    const bomSummaryEmpty = document.getElementById('bom_summary_empty');
    const accessoriesList = document.getElementById('accessories_list');
    const accessoriesEmpty = document.getElementById('accessories_empty');
    const addAccessoryBtn = document.getElementById('add_accessory_btn');
    const exportBtn = document.getElementById('export_pdf');
    const clearBtn = document.getElementById('clear_all');
    const projectModal = document.getElementById('project_modal');
    const projectModalInput = document.getElementById('project_modal_input');
    const projectModalOk = document.getElementById('project_modal_ok');
    const projectModalCancel = document.getElementById('project_modal_cancel');
    const sshDevices = document.getElementById('ssh_devices');
    const sshUsername = document.getElementById('ssh_username');
    const sshPassword = document.getElementById('ssh_password');
    const sshTogglePassword = document.getElementById('ssh_toggle_password');
    const sshCollectBtn = document.getElementById('ssh_collect');
    const sshProgress = document.getElementById('ssh_progress');
    const sshFailurePanel = document.getElementById('ssh_failure_panel');
    const sshFailureSummary = document.getElementById('ssh_failure_summary');
    const sshFailureList = document.getElementById('ssh_failure_list');

    let lastResults = null;
    let lastProjectName = '';
    let hardwareCollectStartedAt = null;
    let hardwareCollectRequested = 0;
    let getAccessoriesPayload = () => [];
    let updateSummaryDisplay = () => {};

    const scheduleSummaryUpdate = (() => {
      let timer = null;
      return () => {
        if (timer !== null) {
          window.clearTimeout(timer);
        }
        timer = window.setTimeout(() => {
          timer = null;
          updateSummaryDisplay();
        }, 50);
      };
    })();

    function resetFailurePanel() {
      if (!sshFailurePanel) return;
      sshFailurePanel.classList.add('hidden');
      if (sshFailureSummary) sshFailureSummary.textContent = '';
      if (sshFailureList) sshFailureList.innerHTML = '';
    }

    function renderFailureDetails(failures, totalRequested) {
      if (!sshFailurePanel || !sshFailureList) return;
      if (!failures?.length) {
        resetFailurePanel();
        return;
      }

      sshFailureList.innerHTML = '';
      const totalText = totalRequested ? `Unable to collect hardware from ${failures.length} of ${totalRequested} device(s).` : `Unable to collect hardware from ${failures.length} device(s).`;
      if (sshFailureSummary) {
        sshFailureSummary.textContent = `${totalText} Hover or tap each device for troubleshooting tips.`;
      }

      failures.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2 rounded-lg border border-rose-200 bg-white/70 px-3 py-2 text-sm text-rose-700 dark:border-rose-900 dark:bg-rose-900/40 dark:text-rose-100';

        const label = item.label || item.host || 'Device';
        const info = item.error_info || {};
        const reasonText = info.reason || item.error || 'Connection failed.';
        const summaryText = `${label} - ${reasonText}`;

        const textSpan = document.createElement('span');
        textSpan.className = 'flex-1';
        textSpan.textContent = summaryText;
        li.appendChild(textSpan);

        const tooltipLines = [];
        if (info.suggestion) {
          tooltipLines.push(`Suggestion: ${info.suggestion}`);
        }
        if (info.detail && info.detail !== reasonText) {
          tooltipLines.push(`Detail: ${info.detail}`);
        }
        const tooltipText = tooltipLines.length ? `${reasonText}\n\n${tooltipLines.join('\n')}` : reasonText;
        li.title = tooltipText;

        if (tooltipLines.length) {
          const icon = document.createElement('span');
          icon.className = 'shrink-0 text-xs font-semibold uppercase tracking-wide text-rose-600 dark:text-rose-200 cursor-help';
          icon.textContent = 'Details';
          icon.title = tooltipText;
          li.appendChild(icon);
        }

        sshFailureList.appendChild(li);
      });

      sshFailurePanel.classList.remove('hidden');
    }

    const parseQuantity = (value) => {
      if (typeof value === 'number') {
        if (!Number.isFinite(value) || value <= 0) return null;
        return value;
      }
      if (typeof value === 'string') {
        const cleaned = value.trim();
        if (!cleaned) return null;
        const parsed = Number.parseFloat(cleaned);
        if (!Number.isFinite(parsed) || parsed <= 0) return null;
        return parsed;
      }
      return null;
    };

    const formatQuantity = (value) => {
      if (typeof value !== 'number' || !Number.isFinite(value)) return '';
      if (Number.isInteger(value)) return value.toString();
      return value.toLocaleString(undefined, { maximumFractionDigits: 2, minimumFractionDigits: 0 });
    };
    const accessorySort = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });

    const buildBillOfMaterialsSummary = (resultsData, accessoriesData) => {
      const totals = new Map();
      const addToTotals = (name, amount) => {
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        const qty = parseQuantity(amount);
        if (qty === null) return;
        const existing = totals.get(trimmed) || 0;
        totals.set(trimmed, existing + qty);
      };

      if (Array.isArray(resultsData)) {
        resultsData.forEach((file) => {
          const switches = Array.isArray(file?.switches) ? file.switches : [];
          switches.forEach((sw) => {
            const items = Array.isArray(sw?.items) ? sw.items : [];
            items.forEach((item) => {
              const replacement = typeof item?.replacement === 'string' ? item.replacement : '';
              addToTotals(replacement, item?.count);
            });
          });
          const copperTotal = file?.copper_10g_ports?.total;
          const copperQty = parseQuantity(copperTotal);
          if (copperQty !== null) {
            addToTotals('SFPP-10G-T', copperQty);
          }
        });
      }

      if (Array.isArray(accessoriesData)) {
        accessoriesData.forEach((item) => {
          if (!item) return;
          const name = typeof item.name === 'string' ? item.name : '';
          const quantity = item.quantity;
          if (parseQuantity(quantity) !== null) {
            addToTotals(name, quantity);
          } else {
            addToTotals(name, 1);
          }
        });
      }

      return Array.from(totals.entries())
        .map(([name, quantity]) => ({ name, quantity }))
        .sort((a, b) => accessorySort(a.name, b.name));
    };

    const renderBillOfMaterialsSummary = (items) => {
      if (!bomSummarySection || !bomSummaryList || !bomSummaryEmpty) return;
      bomSummaryList.innerHTML = '';
      if (!items.length) {
        bomSummarySection.classList.add('hidden');
        bomSummaryEmpty.classList.remove('hidden');
        return;
      }
      bomSummarySection.classList.remove('hidden');
      bomSummaryEmpty.classList.add('hidden');
      items.forEach(({ name, quantity }) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-4 border-b border-slate-200 dark:border-slate-700 pb-2 last:border-0 last:pb-0';
        const qtySpan = document.createElement('span');
        qtySpan.className = 'font-semibold text-slate-900 dark:text-slate-100';
        qtySpan.textContent = formatQuantity(quantity);
        const nameSpan = document.createElement('span');
        nameSpan.className = 'flex-1 text-right md:text-left text-slate-700 dark:text-slate-200';
        nameSpan.textContent = name;
        li.append(qtySpan, nameSpan);
        bomSummaryList.appendChild(li);
      });
    };

    updateSummaryDisplay = () => {
      const accessoriesSelection = getAccessoriesPayload();
      const summaryItems = buildBillOfMaterialsSummary(lastResults, accessoriesSelection);
      renderBillOfMaterialsSummary(summaryItems);
    };

    if (accessoriesList && accessoriesEmpty && addAccessoryBtn) {
      let availableAccessories = [];
      let accessoryRowCounter = 0;

      const disableAddAccessory = () => {
        addAccessoryBtn.disabled = true;
        addAccessoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
      };

      const enableAddAccessory = () => {
        addAccessoryBtn.disabled = false;
        addAccessoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      };

      const updateAccessoriesEmptyState = () => {
        const rows = accessoriesList.querySelectorAll('[data-accessory-row]').length;
        if (rows === 0) {
          accessoriesEmpty.textContent = availableAccessories.length
            ? 'No accessories added yet. Use the button above to include them.'
            : 'No approved accessories available yet. Manage accessories on the Replacement Rules page.';
          accessoriesEmpty.classList.remove('hidden');
        } else {
          accessoriesEmpty.classList.add('hidden');
        }
      };

      const fillAccessoryOptions = (select, selectedValue = '') => {
        const sortedAccessories = [...availableAccessories].sort(accessorySort);
        select.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = sortedAccessories.length ? 'Select accessory' : 'No accessories available';
        placeholder.disabled = true;
        placeholder.selected = !selectedValue;
        select.appendChild(placeholder);
        sortedAccessories.forEach((name) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          if (name === selectedValue) opt.selected = true;
          select.appendChild(opt);
        });
        if (selectedValue && !sortedAccessories.includes(selectedValue)) {
          const opt = document.createElement('option');
          opt.value = selectedValue;
          opt.textContent = `${selectedValue} (no longer approved)`;
          opt.selected = true;
          select.appendChild(opt);
        }
      };

      const refreshAccessorySelects = () => {
        accessoriesList.querySelectorAll('select').forEach((select) => {
          const current = select.value;
          fillAccessoryOptions(select, current);
        });
      };

      const createAccessoryRow = (initial = {}) => {
        accessoryRowCounter += 1;
        const row = document.createElement('div');
        row.dataset.accessoryRow = 'true';
        row.className = 'grid gap-3 md:grid-cols-[minmax(0,1fr)_120px_auto] items-end p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/40';

        const selectId = `accessory_select_${accessoryRowCounter}`;
        const qtyId = `accessory_qty_${accessoryRowCounter}`;

        const selectWrapper = document.createElement('div');
        selectWrapper.className = 'flex flex-col gap-1';
        const selectLabel = document.createElement('label');
        selectLabel.className = 'text-xs font-semibold uppercase text-slate-500';
        selectLabel.htmlFor = selectId;
        selectLabel.textContent = 'Accessory';
        const select = document.createElement('select');
        select.id = selectId;
        select.className = 'border rounded-lg p-2 dark:bg-slate-900 dark:border-slate-700';
        fillAccessoryOptions(select, initial.name || '');
        selectWrapper.append(selectLabel, select);
        row.appendChild(selectWrapper);

        const qtyWrapper = document.createElement('div');
        qtyWrapper.className = 'flex flex-col gap-1';
        const qtyLabel = document.createElement('label');
        qtyLabel.className = 'text-xs font-semibold uppercase text-slate-500';
        qtyLabel.htmlFor = qtyId;
        qtyLabel.textContent = 'Quantity';
        const qtyInput = document.createElement('input');
        qtyInput.id = qtyId;
        qtyInput.type = 'number';
        qtyInput.min = '1';
        qtyInput.step = '1';
        qtyInput.className = 'border rounded-lg p-2 dark:bg-slate-900 dark:border-slate-700';
        qtyInput.placeholder = 'Qty';
        if (initial.quantity !== undefined && initial.quantity !== null && initial.quantity !== '') {
          qtyInput.value = String(initial.quantity);
        } else {
          qtyInput.value = '1';
        }
        qtyWrapper.append(qtyLabel, qtyInput);
        row.appendChild(qtyWrapper);

        const actions = document.createElement('div');
        actions.className = 'flex items-center justify-end md:justify-center';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'text-sm text-red-600 hover:text-red-700';
        removeBtn.textContent = 'Remove';
        actions.appendChild(removeBtn);
        row.appendChild(actions);

        select.addEventListener('change', () => {
          updateAccessoriesEmptyState();
          scheduleSummaryUpdate();
        });
        qtyInput.addEventListener('input', () => {
          if (qtyInput.value === '') return;
          const value = Number.parseInt(qtyInput.value, 10);
          if (Number.isNaN(value) || value < 1) {
            qtyInput.value = '';
          }
          scheduleSummaryUpdate();
        });
        removeBtn.addEventListener('click', (event) => {
          event.preventDefault();
          row.remove();
          updateAccessoriesEmptyState();
          scheduleSummaryUpdate();
        });

        return row;
      };

      const addAccessoryRow = (initial = {}) => {
        const row = createAccessoryRow(initial);
        accessoriesList.appendChild(row);
        updateAccessoriesEmptyState();
        scheduleSummaryUpdate();
        return row;
      };

      getAccessoriesPayload = () => {
        const rows = Array.from(accessoriesList.querySelectorAll('[data-accessory-row]'));
        return rows
          .map((row) => {
            const select = row.querySelector('select');
            const qtyInput = row.querySelector('input[type="number"]');
            if (!select) return null;
            const name = select.value.trim();
            if (!name) return null;
            let quantityValue = '';
            if (qtyInput) {
              const parsed = Number.parseInt(qtyInput.value, 10);
              if (!Number.isNaN(parsed) && parsed > 0) {
                quantityValue = parsed;
              }
            }
            return quantityValue ? { name, quantity: quantityValue } : { name };
          })
          .filter(Boolean);
      };

      addAccessoryBtn.addEventListener('click', (event) => {
        event.preventDefault();
        if (addAccessoryBtn.disabled) return;
        addAccessoryRow();
      });

      disableAddAccessory();
      if (accessoriesEmpty) {
        accessoriesEmpty.textContent = 'Loading approved accessories…';
        accessoriesEmpty.classList.remove('hidden');
      }

      fetch('/api/replacements')
        .then((res) => res.json())
        .then((data) => {
          if (data.ok) {
            const accessories = Array.isArray(data.doc?.accessories)
              ? data.doc.accessories
              : [];
            availableAccessories = Array.from(
              new Set(
                accessories
                  .filter((item) => typeof item === 'string')
                  .map((item) => item.trim())
                  .filter(Boolean)
              )
            );
            if (availableAccessories.length) {
              enableAddAccessory();
            } else {
              disableAddAccessory();
            }
            refreshAccessorySelects();
            updateAccessoriesEmptyState();
          } else {
            accessoriesEmpty.textContent = data.error || 'Unable to load accessories.';
            disableAddAccessory();
            accessoriesEmpty.classList.remove('hidden');
          }
        })
        .catch((err) => {
          console.error('Failed to load accessories', err);
          accessoriesEmpty.textContent = 'Unable to load accessories. Refresh the page or manage them on the Replacement Rules page.';
          disableAddAccessory();
          accessoriesEmpty.classList.remove('hidden');
        });
    }

    scheduleSummaryUpdate();

    async function logTiming(eventName, durationMs, metadata = {}){
      try {
        await fetch('/api/log_timing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event: eventName,
            duration_ms: Math.max(0, Math.round(durationMs)),
            metadata
          })
        });
      } catch (err) {
        console.warn('Failed to log timing metric', err);
      }
    }
    const savedUser = localStorage.getItem('ssh_username');
    if (savedUser) sshUsername.value = savedUser;

    sshTogglePassword.addEventListener('click', () => {
      const isHidden = sshPassword.type === 'password';
      sshPassword.type = isHidden ? 'text' : 'password';
      sshTogglePassword.textContent = isHidden ? 'Hide' : 'Show';
    });

    sshCollectBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (sshCollectBtn.disabled) return;
      const devices = sshDevices.value.split(/\r?\n|,/).map(v => v.trim()).filter(Boolean).map(host => ({ host, label: host }));
      if (!devices.length) {
        uploadStatus.textContent = 'Enter at least one device hostname or IP.';
        return;
      }
      const username = sshUsername.value.trim();
      const password = sshPassword.value;
      if (!username || !password) {
        uploadStatus.textContent = 'SSH username and password are required.';
        return;
      }

      resetFailurePanel();
      sshCollectBtn.disabled = true;
      sshCollectBtn.classList.add('opacity-70', 'cursor-not-allowed');
      sshProgress.textContent = 'Starting SSH collection…';
      uploadStatus.textContent = '';
      hardwareCollectStartedAt = performance.now();
      hardwareCollectRequested = devices.length;

      try {
        const res = await fetch('/api/ssh/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, devices })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || res.statusText || 'Failed to start job');
        localStorage.setItem('ssh_username', username);
        sshPassword.value = '';
        pollJobStatus(data.job_id);
      } catch (err) {
        uploadStatus.textContent = 'Error starting job: ' + (err?.message || err);
        sshCollectBtn.disabled = false;
        sshCollectBtn.classList.remove('opacity-70', 'cursor-not-allowed');
        sshProgress.textContent = '';
        hardwareCollectStartedAt = null;
        hardwareCollectRequested = 0;
        resetFailurePanel();
      }
    });

    function pollJobStatus(jobId){
      let timer = null;
      const fetchStatus = async () => {
        try {
          const res = await fetch(`/api/ssh/jobs/${jobId}`);
          if (!res.ok) throw new Error(res.statusText || 'Status request failed');
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'Status error');
          const job = data.job || {};
          const updates = job.updates || [];
          if (job.message) {
            if (updates.length) {
              const last = updates[updates.length - 1];
              const detail = last?.device ? `${last.device} (${last.status})` : '';
              sshProgress.textContent = detail ? `${job.message} • ${detail}` : job.message;
            } else {
              sshProgress.textContent = job.message;
            }
          }

          if (job.status === 'complete') {
            clearInterval(timer);
            handleJobComplete(job);
            sshCollectBtn.disabled = false;
            sshCollectBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            sshProgress.textContent = '';
          }
        } catch (err) {
          clearInterval(timer);
          uploadStatus.textContent = 'Error retrieving status: ' + (err?.message || err);
          sshCollectBtn.disabled = false;
          sshCollectBtn.classList.remove('opacity-70', 'cursor-not-allowed');
          sshProgress.textContent = '';
          hardwareCollectStartedAt = null;
          hardwareCollectRequested = 0;
          resetFailurePanel();
        }
      };
      fetchStatus();
      timer = setInterval(fetchStatus, 1500);
    }

    function handleJobComplete(job){
      const resultsArr = (job.results || []);
      const successes = resultsArr.filter(r => r.status === 'ok' && r.hardware);
      const failures = resultsArr.filter(r => r.status !== 'ok');
      const totalDevices = Number(job?.total || 0) || (successes.length + failures.length) || hardwareCollectRequested || 0;

      if (successes.length){
        lastResults = successes.map(r => r.hardware);
        renderResults(lastResults);
        uploadStatus.textContent = `Collected hardware from ${successes.length} device(s).` + (failures.length ? ` ${failures.length} failed – hover over the entries below for tips.` : '');
        exportBtn.classList.remove('hidden');
        if (hardwareCollectStartedAt !== null){
          const duration = performance.now() - hardwareCollectStartedAt;
          logTiming('hardware_collect_results', duration, {
            devices_requested: hardwareCollectRequested,
            successes: successes.length,
            failures: failures.length
          });
        }
      } else {
        lastResults = null;
        results.innerHTML = '';
        results.classList.add('hidden');
        exportBtn.classList.add('hidden');
        uploadStatus.textContent = failures.length ? `Unable to collect hardware from any devices (${failures.length} failed). Hover over the entries below for tips.` : 'No hardware data collected.';
        updateSummaryDisplay();
      }

      hardwareCollectStartedAt = null;
      hardwareCollectRequested = 0;

      renderFailureDetails(failures, totalDevices);
      if (failures.length){
        const lines = failures.map((f) => {
          const info = f.error_info || {};
          const label = f.label || f.host || 'Device';
          const reason = info.reason || f.error || 'Unknown error';
          return `${label} - ${reason}`;
        });
        const msg = `Failed devices:\n${lines.join('\n')}`;
        console.warn(msg);
      }
    }

    chooseBtn.addEventListener('click', (e) => { e.preventDefault(); fileInput.value=''; fileInput.click(); });
    dz.addEventListener('click', (e) => { if (e.target === dz) { fileInput.value=''; fileInput.click(); }});
    dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('dragover'); handleFiles([...e.dataTransfer.files]); });
    fileInput.addEventListener('change', () => { handleFiles([...fileInput.files]); fileInput.value=''; });

    clearBtn.addEventListener('click', () => {
      results.innerHTML = '';
      results.classList.add('hidden');
      uploadStatus.textContent = '';
      exportBtn.classList.add('hidden');
      lastResults = null;
      updateSummaryDisplay();
      resetFailurePanel();
    });

    function handleFiles(files){
      if(!files.length) return;
      resetFailurePanel();
      const fd = new FormData();
      files.forEach(f => fd.append('files', f));
      uploadStatus.textContent = 'Processing...';
      fetch('/api/showtech', { method:'POST', body: fd })
        .then(r => r.json())
        .then(data => {
          if(!data.ok) throw new Error(data.error || 'error');
          lastResults = data.results;
          renderResults(data.results);
          uploadStatus.textContent = `Processed ${data.results.length} file(s)`;
          exportBtn.classList.remove('hidden');
        })
        .catch(err => {
          uploadStatus.textContent = 'Error: ' + err.message;
        });
    }

    function renderResults(items){
      results.innerHTML='';
      if(!items?.length){ results.classList.add('hidden'); updateSummaryDisplay(); return; }
      results.classList.remove('hidden');
      items.forEach(file => {
        const wrap = document.createElement('div');
        wrap.className = 'bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-4';
        const h = document.createElement('h3');
        h.className = 'font-medium mb-2';
        h.textContent = file.filename;
        wrap.appendChild(h);
        file.switches.forEach(sw => {
          const s = document.createElement('div');
          s.className = 'mb-2';
          const sh = document.createElement('h4');
          sh.className = 'font-semibold';
          sh.textContent = sw.switch;
          s.appendChild(sh);
          const ul = document.createElement('ul');
          sw.items.forEach(it => {
            const li = document.createElement('li');
            li.textContent = `${it.pid} x${it.count} -> ${it.replacement}`;
            ul.appendChild(li);
          });
          s.appendChild(ul);
          wrap.appendChild(s);
        });
        if(file.copper_10g_ports?.total){
          const p = document.createElement('p');
          p.className = 'mt-2 font-semibold';
          p.textContent = `10Gb copper ports requiring SFPs (SFPP-10G-T): ${file.copper_10g_ports.total}`;
          wrap.appendChild(p);
        }
        results.appendChild(wrap);
      });
      updateSummaryDisplay();
    }

    let resolveProjectModal;

    function openProjectModal() {
      return new Promise((resolve) => {
        resolveProjectModal = resolve;
        if (projectModal) {
          projectModalInput.value = lastProjectName || '';
          projectModal.classList.remove('hidden');
          window.setTimeout(() => projectModalInput.focus(), 0);
        } else {
          resolve({ confirmed: true, value: lastProjectName || '' });
        }
      });
    }

    function closeProjectModal(confirmed) {
      if (!resolveProjectModal) return;
      const value = projectModalInput.value.trim();
      projectModal?.classList.add('hidden');
      const resolver = resolveProjectModal;
      resolveProjectModal = null;
      resolver({ confirmed, value });
    }

    projectModalOk?.addEventListener('click', () => closeProjectModal(true));
    projectModalCancel?.addEventListener('click', () => closeProjectModal(false));
    projectModalInput?.addEventListener('keydown', (evt) => {
      if (evt.key === 'Enter') {
        evt.preventDefault();
        closeProjectModal(true);
      } else if (evt.key === 'Escape') {
        evt.preventDefault();
        closeProjectModal(false);
      }
    });

    function buildReportFilename(projectName) {
      const base = 'hardware_conversion_report';
      if (!projectName) return `${base}.pdf`;
      let fragment = projectName.trim().replace(/[^A-Za-z0-9._-]+/g, '_').replace(/^[_\.-]+|[_\.-]+$/g, '');
      if (!fragment) return `${base}.pdf`;
      if (fragment.length > 64) {
        fragment = fragment.slice(0, 64).replace(/[_\.-]+$/g, '');
      }
      if (!fragment) return `${base}.pdf`;
      return `${base}_${fragment}.pdf`;
    }

    function extractFilenameFromDisposition(disposition) {
      if (!disposition) return null;
      const match = disposition.match(/filename=([^;]+)/i);
      if (!match || !match[1]) return null;
      return match[1].trim().replace(/^"|"$/g, '');
    }

    exportBtn.addEventListener('click', () => {
      if(!lastResults) return;
      openProjectModal().then(({ confirmed, value }) => {
        if (confirmed) {
          lastProjectName = value;
        }
        const projectName = lastProjectName;
        const accessoriesSelection = getAccessoriesPayload();
        fetch('/api/showtech/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ results: lastResults, generated_by: currentUserName, project_name: projectName || null, accessories: accessoriesSelection })
        })
          .then(res => Promise.all([res.blob(), Promise.resolve(res.headers.get('Content-Disposition'))]))
          .then(([blob, disposition]) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            let downloadName = extractFilenameFromDisposition(disposition) || buildReportFilename(projectName);
            if (!downloadName || typeof downloadName !== 'string') {
              downloadName = 'hardware_conversion_report.pdf';
            }
            a.href = url; a.download = downloadName;
            document.body.appendChild(a); a.click(); a.remove();
            window.URL.revokeObjectURL(url);
          });
      });
    });
  </script>
</body>
</html>
