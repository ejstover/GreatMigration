<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{DOC_TITLE}}</title>
  <link rel="icon" type="image/png" href="/static/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'media' };</script>
  </head>
  <body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 overflow-x-hidden">
    <nav id="menu" class="fixed inset-y-0 left-0 w-64 bg-white text-slate-900 dark:bg-slate-800 dark:text-slate-100 transform -translate-x-full transition-transform duration-300 z-50 shadow-lg p-4 space-y-2">
      <p id="user_greeting" class="hidden px-4 py-2 font-semibold"></p>
      <a href="/hardware" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_HARDWARE}}</a>
      <a href="/replacements" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_REPLACEMENTS}}</a>
      <a href="/" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_CONFIG}}</a>
      <a href="/rules" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_RULES}}</a>
      <a href="/audit" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">{{NAV_AUDIT}}</a>
      <a href="{{HELP_URL}}" target="_blank" rel="noopener" class="block px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Help</a>
      <button id="logout_btn" class="hidden w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700">Log out</button>
    </nav>
    <div id="main" class="transition-all duration-300">
    <header class="mb-6 bg-gradient-to-r from-emerald-500 to-sky-500 text-white shadow-lg">
      <div class="max-w-7xl mx-auto flex items-center gap-4 p-6">
        <button id="menu_btn" class="p-2 rounded hover:bg-white/30" aria-label="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex items-center gap-4">
          <img src="/static/logo.png" alt="Logo" class="h-16 w-16" />
          <div>
            <h1 class="text-3xl font-bold">{{BANNER_TITLE}}</h1>
            <p class="text-slate-100 text-sm md:text-base">{{BANNER_TAGLINE}}</p>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-5xl mx-auto p-6 space-y-8">
      <section class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-6">
        <div class="mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <h2 class="text-lg font-medium">Replacement Rules</h2>
          <div class="flex items-center gap-2">
            <button id="add_rule" class="add_rule px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Add Rule</button>
            <button id="save_rules" class="save_rules px-3 py-1 rounded bg-sky-600 text-white hover:bg-sky-700 text-sm">Save</button>
            <button id="cancel_rules" class="cancel_rules px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700 text-sm">Cancel</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-300 dark:divide-slate-700 text-sm">
            <thead class="bg-slate-100 dark:bg-slate-800">
              <tr>
                <th class="p-2 text-left">Cisco Model</th>
                <th class="p-2 text-left">Juniper Model</th>
                <th class="p-2"></th>
              </tr>
            </thead>
            <tbody id="rules_tbody" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
          </table>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="add_rule_bottom" class="add_rule px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Add Rule</button>
          <button id="save_rules_bottom" class="save_rules px-3 py-1 rounded bg-sky-600 text-white hover:bg-sky-700 text-sm">Save</button>
          <button id="cancel_rules_bottom" class="cancel_rules px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700 text-sm">Cancel</button>
        </div>
      </section>

      <section class="bg-white dark:bg-slate-800 dark:border-slate-700 rounded-2xl shadow p-6">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-4">
          <div>
            <h3 class="text-lg font-medium">Accessories</h3>
            <p class="text-sm text-slate-600 dark:text-slate-300">Manage the list of approved accessories available on the hardware conversion page.</p>
          </div>
        </div>
        <div class="flex flex-col gap-3 md:flex-row md:items-end">
          <div class="flex-1">
            <label for="accessory_name" class="block text-sm font-medium mb-1">Accessory name</label>
            <input id="accessory_name" type="text" class="w-full border rounded-lg p-2 dark:bg-slate-900 dark:border-slate-700" placeholder="e.g. SFPP-10G-T" />
          </div>
          <button id="accessory_add_btn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Add Accessory</button>
        </div>
        <div class="mt-4 space-y-2" id="accessories_list"></div>
        <p id="accessories_empty" class="text-sm text-slate-600 dark:text-slate-300 mt-2">No accessories defined yet.</p>
      </section>

      <div id="save_status" class="text-sm text-slate-600 dark:text-slate-300"></div>
    </div>

  <div id="model_modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 p-6 rounded shadow-lg w-80">
      <h3 id="modal_title" class="text-lg font-medium mb-3"></h3>
      <input id="modal_input" type="text" class="w-full border rounded p-2 mb-4 dark:bg-slate-900 dark:border-slate-700" />
      <div class="flex justify-end gap-2">
        <button id="modal_cancel" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">Cancel</button>
        <button id="modal_ok" class="px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700">OK</button>
      </div>
    </div>
    </div>
    </div>

  <script>
  const menuBtn = document.getElementById('menu_btn');
  const menu = document.getElementById('menu');
  const main = document.getElementById('main');
  menuBtn.addEventListener('click', () => {
    menu.classList.toggle('-translate-x-full');
    main.classList.toggle('ml-64');
  });
  document.addEventListener('click', e => {
    if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
      menu.classList.add('-translate-x-full');
      main.classList.remove('ml-64');
    }
  });

const userGreeting = document.getElementById('user_greeting');
const logoutBtn = document.getElementById('logout_btn');
fetch('/me').then(res => {
  if (!res.ok) throw new Error('not authed');
  return res.json();
}).then(data => {
  userGreeting.textContent = `Hey ${data.user.name}!`;
  userGreeting.classList.remove('hidden');
  logoutBtn?.classList.remove('hidden');
  logoutBtn?.addEventListener('click', (e) => { e.preventDefault(); window.location.href = '/logout'; });
}).catch(() => { window.location.href = '/login'; });

const tbody = document.getElementById('rules_tbody');
const addRuleBtns = document.querySelectorAll('.add_rule');
const saveBtns = document.querySelectorAll('.save_rules');
const cancelBtns = document.querySelectorAll('.cancel_rules');
const saveStatus = document.getElementById('save_status');
const accessoriesList = document.getElementById('accessories_list');
const accessoriesEmpty = document.getElementById('accessories_empty');
const accessoryInput = document.getElementById('accessory_name');
const accessoryAddBtn = document.getElementById('accessory_add_btn');
const modal = document.getElementById('model_modal');
const modalTitle = document.getElementById('modal_title');
const modalInput = document.getElementById('modal_input');
const modalOk = document.getElementById('modal_ok');
const modalCancel = document.getElementById('modal_cancel');
let pendingSelect = null;
let pendingVendor = '';
let rulesDoc = {rules: [], accessories: []};
let ciscoTypes = [];
let juniperTypes = [];

function openModal(sel, vendor){
  pendingSelect = sel;
  pendingVendor = vendor;
  modalTitle.textContent = `Add ${vendor} model`;
  modalInput.value='';
  modal.classList.remove('hidden');
  modalInput.focus();
}

function decorateSelect(sel, vendor){
  sel.addEventListener('change', () => {
    if(sel.value === '__add_new__'){
      openModal(sel, vendor);
    } else {
      syncRulesFromDOM();
    }
  });
}

function updateAccessoriesEmptyState(){
  if(!accessoriesEmpty) return;
  const hasItems = Array.isArray(rulesDoc.accessories) && rulesDoc.accessories.length > 0;
  if(hasItems){
    accessoriesEmpty.classList.add('hidden');
  } else {
    accessoriesEmpty.textContent = 'No accessories defined yet.';
    accessoriesEmpty.classList.remove('hidden');
  }
}

function renderAccessories(){
  if(!accessoriesList) return;
  accessoriesList.innerHTML = '';
  const items = Array.isArray(rulesDoc.accessories) ? rulesDoc.accessories : [];
  if(!items.length){
    updateAccessoriesEmptyState();
    return;
  }
  items.forEach((name, idx) => {
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between rounded-lg border border-slate-200 dark:border-slate-700 px-3 py-2';
    const label = document.createElement('span');
    label.className = 'text-sm';
    label.textContent = name;
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'text-sm text-red-600 hover:text-red-700';
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', () => {
      if(Array.isArray(rulesDoc.accessories)){
        rulesDoc.accessories.splice(idx, 1);
      }
      renderAccessories();
    });
    row.appendChild(label);
    row.appendChild(removeBtn);
    accessoriesList.appendChild(row);
  });
  updateAccessoriesEmptyState();
}

if (accessoryAddBtn && accessoryInput) {
  accessoryAddBtn.addEventListener('click', () => {
    const value = accessoryInput.value.trim();
    if(!value){
      accessoryInput.focus();
      return;
    }
    if(!Array.isArray(rulesDoc.accessories)){
      rulesDoc.accessories = [];
    }
    const duplicate = rulesDoc.accessories.some((item) => item.toLowerCase() === value.toLowerCase());
    if(duplicate){
      if(saveStatus){
        saveStatus.textContent = 'Accessory already exists.';
        setTimeout(() => {
          if(saveStatus.textContent === 'Accessory already exists.'){
            saveStatus.textContent = '';
          }
        }, 2000);
      }
      accessoryInput.focus();
      return;
    }
    rulesDoc.accessories.push(value);
    rulesDoc.accessories.sort((a,b)=>a.localeCompare(b));
    accessoryInput.value = '';
    renderAccessories();
  });

  accessoryInput.addEventListener('keydown', (event) => {
    if(event.key === 'Enter'){
      event.preventDefault();
      accessoryAddBtn.click();
    }
  });
}

updateAccessoriesEmptyState();

function renderRules(){
  tbody.innerHTML='';
  rulesDoc.rules.forEach((rule, idx)=>{
    const tr=document.createElement('tr');
    tr.dataset.idx=idx;
    tr.innerHTML=`<td class="p-2"><select class="cisco border rounded p-1 w-full bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 dark:border-slate-700"></select></td>
      <td class="p-2"><select class="juniper border rounded p-1 w-full bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100 dark:border-slate-700"></select></td>
      <td class="p-2"><button class="del text-red-500">✕</button></td>`;
    const cSel = tr.querySelector('.cisco');
    const jSel = tr.querySelector('.juniper');
    const addOpt=document.createElement('option'); addOpt.value='__add_new__'; addOpt.textContent='Add New';
    const empty=document.createElement('option'); empty.value=''; empty.textContent='--model--'; empty.disabled=true; empty.selected=true;
    cSel.appendChild(addOpt.cloneNode(true));
    cSel.appendChild(empty.cloneNode(true));
    jSel.appendChild(addOpt.cloneNode(true));
    jSel.appendChild(empty.cloneNode(true));
    ciscoTypes.forEach(m=>{const o=document.createElement('option'); o.value=m; o.textContent=m; cSel.appendChild(o);});
    juniperTypes.forEach(m=>{const o=document.createElement('option'); o.value=m; o.textContent=m; jSel.appendChild(o);});
    if(rule.cisco && !ciscoTypes.includes(rule.cisco)){ const o=document.createElement('option'); o.value=rule.cisco; o.textContent=rule.cisco; cSel.appendChild(o); }
    if(rule.juniper && !juniperTypes.includes(rule.juniper)){ const o=document.createElement('option'); o.value=rule.juniper; o.textContent=rule.juniper; jSel.appendChild(o); }
    cSel.value=rule.cisco || '';
    jSel.value=rule.juniper || '';
    decorateSelect(cSel, 'Cisco');
    decorateSelect(jSel, 'Juniper');
    tr.querySelector('.del').addEventListener('click',()=>{ rulesDoc.rules.splice(idx,1); renderRules(); });
    tbody.appendChild(tr);
  });
}

function syncRulesFromDOM(){
  rulesDoc.rules=[...tbody.querySelectorAll('tr')].map(tr=>({
    cisco: tr.querySelector('.cisco').value,
    juniper: tr.querySelector('.juniper').value
  }));
}

addRuleBtns.forEach(btn=>btn.addEventListener('click',()=>{ syncRulesFromDOM(); rulesDoc.rules.push({cisco:'', juniper:''}); renderRules(); tbody.lastElementChild?.scrollIntoView({behavior:'smooth'}); }));

saveBtns.forEach(btn=>btn.addEventListener('click',()=>{
  syncRulesFromDOM();
  const filteredRules = rulesDoc.rules.filter(r=>r.cisco && r.juniper);
  const accessoriesPayload = Array.isArray(rulesDoc.accessories)
    ? Array.from(
        new Map(
          rulesDoc.accessories
            .filter(name=>typeof name === 'string')
            .map(name=>name.trim())
            .filter(Boolean)
            .map(name=>[name.toLowerCase(), name])
        ).values()
      ).sort((a,b)=>a.localeCompare(b))
    : [];
  const payload = {rules: filteredRules, accessories: accessoriesPayload};
  fetch('/api/replacements',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
    .then(async r=>{const txt=await r.text(); try{return JSON.parse(txt);}catch{return {ok:false,error:txt};}})
    .then(resp=>{
      if(resp.ok){ saveStatus.textContent='Saved!'; setTimeout(()=>saveStatus.textContent='',2000); }
      else { saveStatus.textContent='Error: '+resp.error; }
    }).catch(e=>{ saveStatus.textContent='Error: '+e; });
}));

cancelBtns.forEach(btn=>btn.addEventListener('click',()=>{ window.location.href='/'; }));

Promise.all([
  fetch('/api/device_types?vendor=Cisco').then(r=>r.json()),
  fetch('/api/device_types?vendor=Juniper').then(r=>r.json()),
  fetch('/api/replacements').then(r=>r.json())
]).then(([cisco,juniper,rules])=>{
  if(cisco.ok) ciscoTypes=cisco.items; else console.error(cisco.error);
  if(juniper.ok) juniperTypes=juniper.items; else console.error(juniper.error);
  if(rules.ok){
    const doc = rules.doc || {};
    const incomingRules = Array.isArray(doc.rules) ? doc.rules : [];
    const accessoriesMap = new Map();
    if(Array.isArray(doc.accessories)){
      doc.accessories.forEach(name=>{
        if(typeof name !== 'string') return;
        const trimmed = name.trim();
        if(!trimmed) return;
        const key = trimmed.toLowerCase();
        if(!accessoriesMap.has(key)) accessoriesMap.set(key, trimmed);
      });
    }
    rulesDoc = {
      rules: incomingRules,
      accessories: Array.from(accessoriesMap.values()).sort((a,b)=>a.localeCompare(b))
    };
    rulesDoc.rules.forEach(r=>{
      if(r.cisco && !ciscoTypes.includes(r.cisco)) ciscoTypes.push(r.cisco);
      if(r.juniper && !juniperTypes.includes(r.juniper)) juniperTypes.push(r.juniper);
    });
  } else {
    rulesDoc = {rules: [], accessories: []};
  }
  ciscoTypes.sort((a,b)=>a.localeCompare(b));
  juniperTypes.sort((a,b)=>a.localeCompare(b));
  renderRules();
  renderAccessories();
}).catch(err=>{ console.error(err); renderRules(); renderAccessories(); });

modalOk.addEventListener('click', () => {
  const val = modalInput.value.trim();
  if(val){
    const arr = pendingVendor==='Cisco' ? ciscoTypes : juniperTypes;
    if(!arr.includes(val)){ arr.push(val); arr.sort((a,b)=>a.localeCompare(b)); }

    const row = pendingSelect.closest('tr');
    let idx = -1;
    if(row){
      idx = Number(row.dataset.idx);
      if(pendingVendor==='Cisco') rulesDoc.rules[idx].cisco = val;
      else rulesDoc.rules[idx].juniper = val;
    }

    renderRules();
    if(idx > -1){
      const newSel = tbody.querySelector(`tr[data-idx="${idx}"] .${pendingVendor.toLowerCase()}`);
      if(newSel) newSel.value = val;
    }

    fetch('/api/device_types', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({vendor: pendingVendor, model: val})
    }).then(r=>r.json()).then(resp=>{
      if(!resp.ok){ console.error(resp.error); }
    }).catch(err=>console.error(err));
  } else {
    pendingSelect.value='';
  }
  modal.classList.add('hidden');
});

modalCancel.addEventListener('click', () => {
  if(pendingSelect) pendingSelect.value='';
  modal.classList.add('hidden');
});

modal.addEventListener('click', e => { if(e.target === modal) { modalCancel.click(); } });
</script>
</body>
</html>
